<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid'>/**
</span> * Renders progress for a given list of students across a given list of competencies
 */
Ext.define(&#39;SlateDemonstrationsTeacher.view.StudentsProgressGrid&#39;, {
    extend: &#39;Ext.Component&#39;,
    xtype: &#39;slate-demonstrations-teacher-studentsprogressgrid&#39;,
    requires:[
        &#39;Slate.cbl.Util&#39;,

        &#39;Slate.cbl.widget.Popover&#39;,

        &#39;Slate.cbl.store.Students&#39;,
        &#39;Slate.cbl.store.Competencies&#39;,
        &#39;Slate.cbl.store.Completions&#39;,
        &#39;Slate.cbl.store.DemonstrationSkills&#39;,

        &#39;Slate.cbl.data.Skills&#39;
    ],

    config: {
<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-studentDashboardLink'>        studentDashboardLink: null,
</span><span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-averageFormat'>        averageFormat: &#39;0.##&#39;,
</span><span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-progressFormat'>        progressFormat: &#39;0%&#39;,
</span><span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-flushDemonstrationsBuffer'>        flushDemonstrationsBuffer: 10,
</span>
<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-popover'>        popover: true,
</span>
<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-studentsStore'>        studentsStore: {
</span>            xclass: &#39;Slate.cbl.store.Students&#39;,
            sorters: [{
                property: &#39;LastName&#39;,
                direction: &#39;ASC&#39;
            }]
        },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-competenciesStore'>        competenciesStore: {
</span>            xclass: &#39;Slate.cbl.store.Competencies&#39;
        },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-completionsStore'>        completionsStore: {
</span>            xclass: &#39;Slate.cbl.store.Completions&#39;
        },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-skillsStore'>        skillsStore: &#39;cbl-skills&#39;,
</span>
<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-cfg-demonstrationSkillsStore'>        demonstrationSkillsStore: {
</span>            xclass: &#39;Slate.cbl.store.DemonstrationSkills&#39;
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-property-componentCls'>    componentCls: &#39;cbl-grid-cmp&#39;,
</span>
<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-property-tpl'>    tpl: [
</span>        &#39;{%var studentsCount = values.students.length%}&#39;,
        &#39;&lt;div class=&quot;cbl-grid-ct&quot;&gt;&#39;,
            &#39;&lt;table class=&quot;cbl-grid cbl-grid-competencies&quot;&gt;&#39;,
                &#39;&lt;colgroup class=&quot;cbl-grid-competency-col&quot;&gt;&lt;/colgroup&gt;&#39;,

                &#39;&lt;thead&gt;&#39;,
                    &#39;&lt;tr&gt;&#39;,
                        &#39;&lt;td class=&quot;cbl-grid-corner-cell&quot;&gt;&amp;nbsp;&lt;/td&gt;&#39;,
                    &#39;&lt;/tr&gt;&#39;,
                &#39;&lt;/thead&gt;&#39;,

                &#39;&lt;tbody&gt;&#39;,
                    &#39;&lt;tpl for=&quot;competencies&quot;&gt;&#39;,
                        &#39;&lt;tpl for=&quot;competency&quot;&gt;&#39;,
                            &#39;&lt;tr class=&quot;cbl-grid-progress-row&quot; data-competency=&quot;{ID}&quot;&gt;&#39;,
                                &#39;&lt;th class=&quot;cbl-grid-competency-name&quot;&gt;&lt;div class=&quot;ellipsis&quot;&gt;{Descriptor}&lt;/div&gt;&lt;/th&gt;&#39;,
                            &#39;&lt;/tr&gt;&#39;,
                            &#39;&lt;tr class=&quot;cbl-grid-skills-row&quot; data-competency=&quot;{ID}&quot;&gt;&#39;,
                                &#39;&lt;td class=&quot;cbl-grid-skills-cell&quot;&gt;&#39;,
                                    &#39;&lt;div class=&quot;cbl-grid-skills-ct&quot;&gt;&#39;,
                                        &#39;&lt;table class=&quot;cbl-grid-skills-grid&quot;&gt;&#39;,
                                            &#39;&lt;colgroup class=&quot;cbl-grid-skill-col&quot;&gt;&lt;/colgroup&gt;&#39;,
                                            &#39;&lt;tbody&gt;&lt;/tbody&gt;&#39;,
                                        &#39;&lt;/table&gt;&#39;,
                                    &#39;&lt;/div&gt;&#39;,
                                &#39;&lt;/td&gt;&#39;,
                            &#39;&lt;/tr&gt;&#39;,
                        &#39;&lt;/tpl&gt;&#39;,
                    &#39;&lt;/tpl&gt;&#39;,
                &#39;&lt;/tbody&gt;&#39;,
            &#39;&lt;/table&gt;&#39;,

            &#39;&lt;div class=&quot;cbl-grid-scroll-ct&quot;&gt;&#39;,
                &#39;&lt;table class=&quot;cbl-grid cbl-grid-main&quot;&gt;&#39;,
                    &#39;&lt;colgroup span=&quot;{[studentsCount]}&quot; class=&quot;cbl-grid-progress-col&quot;&gt;&lt;/colgroup&gt;&#39;,

                    &#39;&lt;thead&gt;&#39;,
                        &#39;&lt;tr&gt;&#39;,
                            &#39;&lt;tpl for=&quot;students&quot;&gt;&#39;,
                                &#39;&lt;th class=&quot;cbl-grid-student-name&quot; data-student=&quot;{student.ID}&quot;&gt;&#39;,
                                    &#39;&lt;tpl if=&quot;dashboardUrl&quot;&gt;&lt;a href=&quot;{dashboardUrl}&quot;&gt;&lt;/tpl&gt;&#39;,
                                        &#39;{student.FirstName} {student.LastName}&#39;,
                                    &#39;&lt;tpl if=&quot;dashboardUrl&quot;&gt;&lt;/a&gt;&lt;/tpl&gt;&#39;,
                                &#39;&lt;/th&gt;&#39;,
                            &#39;&lt;/tpl&gt;&#39;,
                        &#39;&lt;/tr&gt;&#39;,
                    &#39;&lt;/thead&gt;&#39;,

                    &#39;&lt;tbody&gt;&#39;,
                        &#39;&lt;tpl for=&quot;competencies&quot;&gt;&#39;,
                            &#39;&lt;tr class=&quot;cbl-grid-progress-row&quot; data-competency=&quot;{competency.ID}&quot;&gt;&#39;,
                                &#39;&lt;tpl for=&quot;students&quot;&gt;&#39;,
                                    &#39;&lt;td class=&quot;cbl-grid-progress-cell&quot; data-student=&quot;{student.ID}&quot;&gt;&#39;,
                                        &#39;&lt;span class=&quot;cbl-grid-progress-bar&quot; style=&quot;width: 0%&quot;&gt;&lt;/span&gt;&#39;,
                                        &#39;&lt;span class=&quot;cbl-grid-progress-level&quot;&gt;&lt;/span&gt;&#39;,
                                        &#39;&lt;span class=&quot;cbl-grid-progress-percent&quot;&gt;&lt;/span&gt;&#39;,
                                        &#39;&lt;span class=&quot;cbl-grid-progress-average&quot;&gt;&lt;/span&gt;&#39;,
                                    &#39;&lt;/td&gt;&#39;,
                                &#39;&lt;/tpl&gt;&#39;,
                            &#39;&lt;/tr&gt;&#39;,
                            &#39;&lt;tr class=&quot;cbl-grid-skills-row&quot; data-competency=&quot;{competency.ID}&quot;&gt;&#39;,
                                &#39;&lt;td class=&quot;cbl-grid-skills-cell&quot; colspan=&quot;{[studentsCount]}&quot;&quot;&gt;&#39;,
                                    &#39;&lt;div class=&quot;cbl-grid-skills-ct&quot;&gt;&#39;,
                                        &#39;&lt;table class=&quot;cbl-grid-skills-grid&quot;&gt;&#39;,
                                            &#39;&lt;colgroup span=&quot;{[studentsCount]}&quot;&quot; class=&quot;cbl-grid-demos-col&quot;&gt;&lt;/colgroup&gt;&#39;,
                                            &#39;&lt;tbody&gt;&lt;/tbody&gt;&#39;,
                                        &#39;&lt;/table&gt;&#39;,
                                    &#39;&lt;/div&gt;&#39;,
                                &#39;&lt;/td&gt;&#39;,
                            &#39;&lt;/tr&gt;&#39;,
                        &#39;&lt;/tpl&gt;&#39;,
                    &#39;&lt;/tbody&gt;&#39;,
                &#39;&lt;/table&gt;&#39;,
            &#39;&lt;/div&gt;&#39;,
        &#39;&lt;/div&gt;&#39;,
        &#39;&lt;div class=&quot;cbl-grid-legend&quot;&gt;&#39;,
            &#39;&lt;span class=&quot;cbl-grid-legend-label&quot;&gt;Portfolios:&amp;ensp;&lt;/span&gt;&#39;,
            &#39;&lt;span class=&quot;cbl-grid-legend-item level-color cbl-level-9&quot;&gt;Y1&lt;/span&gt;&#39;,
            &#39;&lt;span class=&quot;cbl-grid-legend-item level-color cbl-level-10&quot;&gt;Y2&lt;/span&gt;&#39;,
            &#39;&lt;span class=&quot;cbl-grid-legend-item level-color cbl-level-11&quot;&gt;Y3&lt;/span&gt;&#39;,
            &#39;&lt;span class=&quot;cbl-grid-legend-item level-color cbl-level-12&quot;&gt;Y4&lt;/span&gt;&#39;,
        &#39;&lt;/div&gt;&#39;
    ],

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-property-listeners'>    listeners: {
</span>        scope: &#39;this&#39;,
        click: {
            fn: &#39;onGridClick&#39;,
            element: &#39;el&#39;,
            delegate: &#39;.cbl-grid-progress-row, .cbl-grid-demo&#39;
        },
        mouseover: {
            fn: &#39;onSkillNameMouseOver&#39;,
            element: &#39;el&#39;
        }
    },


<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-property-competencySkillsTpl'>    // local subtemplates
</span>    competencySkillsTpl: [
        &#39;&lt;tpl for=&quot;skills&quot;&gt;&#39;,
            &#39;&lt;tr class=&quot;cbl-grid-skill-row&quot; data-skill=&quot;{skill.ID}&quot;&gt;&#39;,
                &#39;&lt;th class=&quot;cbl-grid-skill-name&quot; data-skill-name=&quot;{skill.Descriptor:htmlEncode}&quot; data-skill-description=&quot;{skill.Statement:htmlEncode}&quot;&gt;&#39;,
                    &#39;&lt;div class=&quot;ellipsis&quot;&gt;{skill.Descriptor:htmlEncode}&lt;/div&gt;&#39;,
                &#39;&lt;/th&gt;&#39;,
            &#39;&lt;/tr&gt;&#39;,
        &#39;&lt;/tpl&gt;&#39;
    ],

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-property-competencyDemonstrationsTpl'>    competencyDemonstrationsTpl: [
</span>        &#39;&lt;tpl for=&quot;skills&quot;&gt;&#39;,
            &#39;&lt;tr class=&quot;cbl-grid-skill-row&quot; data-skill=&quot;{skill.ID}&quot;&gt;&#39;,
                &#39;&lt;tpl for=&quot;students&quot;&gt;&#39;,
                    &#39;&lt;td class=&quot;cbl-grid-demos-cell &lt;tpl if=&quot;completion&quot;&gt;cbl-level-{completion.currentLevel}&lt;/tpl&gt;&quot; data-student=&quot;{student.ID}&quot;&gt;&#39;,
                        &#39;&lt;ul class=&quot;cbl-grid-demos&quot;&gt;&#39;,
                            &#39;&lt;tpl for=&quot;demonstrationBlocks&quot;&gt;&#39;,
                                &#39;&lt;li class=&quot;cbl-grid-demo cbl-grid-demo-empty&quot;&gt;&lt;/li&gt;&#39;,
                            &#39;&lt;/tpl&gt;&#39;,
                        &#39;&lt;/ul&gt;&#39;,
                    &#39;&lt;/td&gt;&#39;,
                &#39;&lt;/tpl&gt;&#39;,
            &#39;&lt;/tr&gt;&#39;,
        &#39;&lt;/tpl&gt;&#39;
    ],


<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyPopover'>    // config handlers
</span>    applyPopover: function(newPopover, oldPopover) {
        return Ext.factory(newPopover, &#39;Slate.cbl.widget.Popover&#39;, oldPopover);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyAverageFormat'>    applyAverageFormat: function(format) {
</span>        return Ext.isString(format) ? Ext.util.Format.numberRenderer(format) : format;
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyProgressFormat'>    applyProgressFormat: function(format) {
</span>        return Ext.isString(format) ? Ext.util.Format.numberRenderer(format) : format;
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyStudentsStore'>    applyStudentsStore: function(store) {
</span>        return Ext.StoreMgr.lookup(store);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-updateStudentsStore'>    updateStudentsStore: function(store) {
</span>        if (store) {
            store.on(&#39;refresh&#39;, &#39;refresh&#39;, this);
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyCompetenciesStore'>    applyCompetenciesStore: function(store) {
</span>        return Ext.StoreMgr.lookup(store);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-updateCompetenciesStore'>    updateCompetenciesStore: function(store) {
</span>        if (store) {
            store.on(&#39;refresh&#39;, &#39;refresh&#39;, this);
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyCompletionsStore'>    applyCompletionsStore: function(store) {
</span>        return Ext.StoreMgr.lookup(store);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-updateCompletionsStore'>    updateCompletionsStore: function(store) {
</span>        if (store) {
            store.on({
                scope: this,
                refresh: &#39;onCompletionsRefresh&#39;,
                update: &#39;onCompletionUpdate&#39;
            });
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applySkillsStore'>    applySkillsStore: function(store) {
</span>        return Ext.StoreMgr.lookup(store);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-applyDemonstrationSkillsStore'>    applyDemonstrationSkillsStore: function(store) {
</span>        return Ext.StoreMgr.lookup(store);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-updateDemonstrationSkillsStore'>    updateDemonstrationSkillsStore: function(store) {
</span>        if (store) {
            store.on({
                scope: this,
                refresh: function() { console.log(&#39;ds-&gt;refresh&#39;, arguments); },
                load: &#39;onDemonstrationSkillsLoad&#39;,
                add: &#39;onDemonstrationSkillsAdd&#39;,
                update: &#39;onDemonstrationSkillUpdate&#39;,
                remove: &#39;onDemonstrationSkillsRemove&#39;
            });
        }
    },


<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-afterRender'>    // component lifecycle
</span>    afterRender: function() {
        var me = this;

        me.callParent(arguments);

        me.refresh();

        // create an instance-specific buffer for flushing demonstrations
        me.flushDemonstrations = Ext.Function.createBuffered(me.flushDemonstrations, me.getFlushDemonstrationsBuffer(), me);
    },


<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onGridClick'>    // event handlers
</span>    onGridClick: function(ev, targetEl) {
        var me = this;

        if (targetEl = ev.getTarget(&#39;.cbl-grid-progress-row&#39;, me.el, true)) {
            me.fireEvent(
                &#39;competencyrowclick&#39;,
                me,
                me.getCompetenciesStore().getById(targetEl.getAttribute(&#39;data-competency&#39;), 10),
                ev,
                targetEl
            );
        } else if (targetEl = ev.getTarget(&#39;.cbl-grid-demo&#39;, me.el, true)) {
            me.fireEvent(&#39;democellclick&#39;, me, ev, targetEl);
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onSkillNameMouseOver'>    onSkillNameMouseOver: function(ev) {
</span>        var me = this,
            popover = me.getPopover(),
            dashboardEl = me.el,
            targetEl;

        if (targetEl = ev.getTarget(&#39;.cbl-grid-skill-name&#39;, dashboardEl, true)) {
            if (popover.hidden || popover.alignTarget !== targetEl) {
                popover.showBy(targetEl);
                popover.update({
                    title: targetEl.getAttribute(&#39;data-skill-name&#39;),
                    body: targetEl.getAttribute(&#39;data-skill-description&#39;)
                });
            }
        } else if (!popover.hidden) {
            popover.hide();
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onCompletionsRefresh'>    onCompletionsRefresh: function(completionsStore) {
</span>        console.log(&#39;completions-&gt;refresh&#39;, arguments);

        this.loadCompletions(completionsStore.getRange());
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onCompletionUpdate'>    onCompletionUpdate: function(completionsStore, completion, operation, modifiedFieldNames, details) {
</span>        console.log(&#39;completion-&gt;update&#39;, completion, operation, modifiedFieldNames);

        this.loadCompletions(completion);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onDemonstrationSkillsLoad'>    onDemonstrationSkillsLoad: function(demoSkillsStore, demoSkills) {
</span>        console.log(&#39;ds-&gt;load&#39;, demoSkills);

        this.addDemonstrationSkills(demoSkills);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onDemonstrationSkillsAdd'>    onDemonstrationSkillsAdd: function(demoSkillsStore, demoSkills) {
</span>        console.log(&#39;ds-&gt;add&#39;, demoSkills);

        this.addDemonstrationSkills(demoSkills);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onDemonstrationSkillUpdate'>    onDemonstrationSkillUpdate: function(demoSkillsStore, demoSkill, operation, modifiedFieldNames, details) {
</span>        console.log(&#39;ds-&gt;update&#39;, demoSkill, operation, modifiedFieldNames);

        if (modifiedFieldNames.indexOf(&#39;DemonstratedLevel&#39;) != -1) {
            this.updateDemonstrationSkills([demoSkill]);
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-onDemonstrationSkillsRemove'>    onDemonstrationSkillsRemove: function(demoSkillsStore, demoSkills) {
</span>        console.log(&#39;ds-&gt;remove&#39;, demoSkills);

        this.removeDemonstrationSkills(demoSkills);
    },


    // public methods
<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-toggleCompetency'>    /**
</span>     * Expand or collapse a give competency, loading and rendering associated skills if needed
     *
     * @param {Slate.cbl.model.Competency} competency
     */
    toggleCompetency: function(competency) {
        var me = this,
            competencyRenderData = me.getRenderDataForCompetency(competency),
            skillsRowEl = competencyRenderData.skillsRowEl,
            demonstrationsRowEl = competencyRenderData.demonstrationsRowEl,
            isExpand = !competencyRenderData.expanded,
            eventName = isExpand ? &#39;expand&#39; : &#39;collapse&#39;,
            loadingCls = &#39;is-loading&#39;,
            expandedCls = &#39;is-expanded&#39;,
            skillsHeight = 0,
            _finishExpand, _finishToggle;


        if (me.fireEvent(&#39;beforecompetency&#39;+eventName, me, competency) === false) {
            return;
        }


        Ext.suspendLayouts();


        _finishToggle = function() {
            skillsRowEl.down(&#39;.cbl-grid-skills-ct&#39;).setHeight(skillsHeight);
            demonstrationsRowEl.down(&#39;.cbl-grid-skills-ct&#39;).setHeight(skillsHeight);
            me.fireEvent(&#39;competency&#39;+eventName, me, competency);
            Ext.resumeLayouts(true);
        };

        competencyRenderData.expanded = isExpand;


        // handle collapse
        if (!isExpand) {
            skillsRowEl.removeCls(expandedCls);
            demonstrationsRowEl.removeCls(expandedCls);
            _finishToggle();
            return;
        }


        // handle expand
        _finishExpand = function() {
            skillsHeight = skillsRowEl.down(&#39;.cbl-grid-skills-grid&#39;).getHeight();
            skillsRowEl.addCls(expandedCls);
            demonstrationsRowEl.addCls(expandedCls);
            _finishToggle();
        };

        // skills are already loaded &amp; rendered, finish expand immediately
        if (competencyRenderData.skills) {
            _finishExpand();
            return;
        }

        // load demonstrations and skills
        skillsRowEl.addCls(loadingCls);
        demonstrationsRowEl.addCls(loadingCls);

        me.getDemonstrationSkillsStore().loadByStudentsAndCompetencies(me.getStudentsStore().collect(&#39;ID&#39;), competency.getId());

        me.getSkillsStore().getAllByCompetency(competency, function(skillsCollection) {
            var renderData = me.getData(),
                skillsById = renderData.skillsById || (renderData.skillsById = {}),
                competencySkills = competencyRenderData.skills = [],
                demonstrationsBodyEl = demonstrationsRowEl.down(&#39;tbody&#39;),

                studentsStore = me.getStudentsStore(),
                studentsCount = studentsStore.getCount(), studentIndex, student,

                skillsCount = skillsCollection.getCount(), skillIndex, skill,

                skillRenderData, studentsRenderData, studentRenderData, studentsById, skillRowEl, demonstrationsCellEl,
                studentCompletion, demonstrationsRequired;

            // build new skills render tree and update root skill index
            for (skillIndex = 0; skillIndex &lt; skillsCount; skillIndex++) {
                skill = skillsCollection.getAt(skillIndex);
                skillRenderData = {
                    skill: skill.data,
                    students: studentsRenderData = [],
                    studentsById: studentsById = {}
                };

                competencySkills.push(skillRenderData);
                skillsById[skill.getId()] = skillRenderData;

                for (studentIndex = 0; studentIndex &lt; studentsCount; studentIndex++) {
                    student = studentsStore.getAt(studentIndex);
                    studentCompletion = competencyRenderData.studentsById[student.getId()].completion;

                    studentRenderData = {
                        student: student.data,
                        completion: studentCompletion,
                        demonstrationBlocks: Slate.cbl.Util.padArray([], skill.getTotalDemonstrationsRequired(studentCompletion ? studentCompletion.currentLevel : null), true)
                    };

                    studentsRenderData.push(studentRenderData);
                    studentsById[student.getId()] = studentRenderData;
                }
            }

            // remove loading state
            skillsRowEl.removeCls(loadingCls);
            demonstrationsRowEl.removeCls(loadingCls);

            // render skill subtables within expanded competency
            me.lookupTpl(&#39;competencySkillsTpl&#39;).overwrite(skillsRowEl.down(&#39;tbody&#39;), competencyRenderData);
            me.lookupTpl(&#39;competencyDemonstrationsTpl&#39;).overwrite(demonstrationsBodyEl, competencyRenderData);

            // decorate renderData with instances
            for (skillIndex = 0; skillIndex &lt; skillsCount; skillIndex++) {
                skillRenderData = competencySkills[skillIndex];
                skillRenderData.skillRowEl = skillRowEl = demonstrationsBodyEl.child(&#39;.cbl-grid-skill-row[data-skill=&quot;&#39;+skillRenderData.skill.ID+&#39;&quot;]&#39;);
                studentsRenderData = skillRenderData.students;

                for (studentIndex = 0; studentIndex &lt; studentsCount; studentIndex++) {
                    studentRenderData = studentsRenderData[studentIndex];
                    studentRenderData.demonstrationsCellEl = demonstrationsCellEl = skillRowEl.child(&#39;.cbl-grid-demos-cell[data-student=&quot;&#39;+studentRenderData.student.ID+&#39;&quot;]&#39;);
                    studentRenderData.demonstrationBlockEls = demonstrationsCellEl.select(&#39;.cbl-grid-demo&#39;, true);
                }
            }

            // finish expand
            Slate.cbl.Util.syncRowHeights(
                skillsRowEl.select(&#39;tr&#39;),
                demonstrationsRowEl.select(&#39;tr&#39;)
            );

            // write any pending demonstrations to the DOM
            me.flushDemonstrations();

            _finishExpand();
        });
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-loadDemonstration'>    /**
</span>     * Read a new or updated demonstration model and apply it to the existing render
     *
     * @param {Slate.cbl.model.Demonstration} demonstration A new or updated demonstration model
     */
    loadDemonstration: function(demonstration) {
        var me = this,
            completionsStore = me.getCompletionsStore(),
            skillsData = demonstration.get(&#39;Skills&#39;),
            competencyCompletions = demonstration.get(&#39;competencyCompletions&#39;),
            i = 0, competencyCompletionsLength = competencyCompletions.length,
            competencyCompletionData, competencyCompletionId, competencyCompletionRecord,
            newCompletions = [];

        for(; i &lt; competencyCompletionsLength; i++) {
            competencyCompletionData = competencyCompletions[i];
            competencyCompletionId = Slate.cbl.model.Completion.getIdFromData(competencyCompletionData);
            competencyCompletionRecord = completionsStore.getById(competencyCompletionId);

            if (competencyCompletionRecord) {
                competencyCompletionRecord.set(competencyCompletionData, {
                    dirty: false
                });
            } else {
                newCompletions.push(competencyCompletionData);
            }
        }

        if (newCompletions.length) {
            completionsStore.add(newCompletions);
        }

        if (skillsData) {
            me.getDemonstrationSkillsStore().mergeRawData(skillsData, demonstration);
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-deleteDemonstration'>    /**
</span>     * Delete a demonstration model and apply it to the existing render
     *
     * @param {Slate.cbl.model.Demonstration} demonstration The demonstration model that was deleted
     */
    deleteDemonstration: function(demonstration) {
        var me = this,
            completionsStore = me.getCompletionsStore(),
            competencyCompletions = demonstration.get(&#39;competencyCompletions&#39;),
            i = 0, competencyCompletionsLength = competencyCompletions.length,
            competencyCompletionData, competencyCompletionId, competencyCompletionRecord;

        for(; i &lt; competencyCompletionsLength; i++) {
            competencyCompletionData = competencyCompletions[i];
            competencyCompletionId = Slate.cbl.model.Completion.getIdFromData(competencyCompletionData);
            competencyCompletionRecord = completionsStore.getById(competencyCompletionId);

            if (competencyCompletionRecord) {
                competencyCompletionRecord.set(competencyCompletionData, {
                    dirty: false
                });
            }
        }

        me.getDemonstrationSkillsStore().mergeRawData([], demonstration);
    },


    // protected methods

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-refresh'>    /**
</span>     * @protected
     * Redraw the dashboard&#39;s primary markup shell based on the already-loaded {@link #config-studentsStore} and {@link #config-competenciesStore}
     */
    refresh: function() {
        var me = this,
            studentsStore = me.getStudentsStore(),
            competenciesStore = me.getCompetenciesStore();

        if (!studentsStore.isLoaded() || !competenciesStore.isLoaded()) {
            return;
        }

        Ext.suspendLayouts();

        me.setData(me.buildRenderData());

        if (me.rendered) {
            me.finishRefresh();
        } else {
            me.on(&#39;render&#39;, &#39;finishRefresh&#39;, me, { single: true });
        }

        // TODO: should this be in finishRefresh instead? what happens if refresh called before render?
        me.getCompletionsStore().loadByStudentsAndCompetencies(
            me.getStudentsStore().collect(&#39;ID&#39;),
            me.getCompetenciesStore().collect(&#39;ID&#39;)
        );

        Ext.resumeLayouts(true);
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-buildRenderData'>    /**
</span>     * @protected
     * Builds render data tree for the progress table&#39;s top-level template, {@link #config-tpl}
     *
     * Each object directly within the `students` and `competencies` arrays is a unique instance to this render tree
     * but contains references to the `data` objects in the corresponding student/competency model instances. The top-
     * level objects may be modified to keep track of render state, but the referenced student/competency data should
     * be treated as read-only. Any changes that need to be made to the underlying student/competency models must be done
     * through the model instances loaded into {@link #config-studentsStore} or {@link #config-competenciesStore} and
     * then the render tree regenerated by calling {@link #method-refresh}
     *
     * @return {Object} renderData
     */
    buildRenderData: function() {
        var me = this,
            studentDashboardLink = me.getStudentDashboardLink(),

            students = me.getStudentsStore().getRange(),
            studentsLength = students.length, studentIndex, student,
            studentsData = [],

            competenciesStore = me.getCompetenciesStore(),
            competenciesLength = competenciesStore.getCount(), competencyIndex, competency, competencyStudentsData,
            competenciesData = [];


        // build array of students
        for (studentIndex = 0; studentIndex &lt; studentsLength; studentIndex++) {
            student = students[studentIndex];
            studentsData.push({
                student: student.data,
                dashboardUrl: studentDashboardLink &amp;&amp; Ext.String.urlAppend(studentDashboardLink, &#39;student=&#39; + window.escape(student.get(&#39;Username&#39;)))
            });
        }


        // build array of competencies
        for (competencyIndex = 0; competencyIndex &lt; competenciesLength; competencyIndex++) {
            competency = competenciesStore.getAt(competencyIndex);

            competenciesData.push({
                competency: competency.data,
                students: competencyStudentsData = []
            });

            for (studentIndex = 0; studentIndex &lt; studentsLength; studentIndex++) {
                student = students[studentIndex];
                competencyStudentsData.push({
                    student: student.data
                });
            }
        }


        return {
            students: studentsData,
            competencies: competenciesData
        };
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-finishRefresh'>    /**
</span>     * @protected
     * Decorates renderData after a redraw with indexes and element references that are useful
     * for applying updates
     *
     * Take care to keep the read and write phases batched for optimal performances, each flip-flop between reading
     * from the DOM and writing to the DOM forces the browser to do a layout run
     */
    finishRefresh: function() {
        var me = this,
            el = me.el,
            renderData = me.getData(),
            competenciesTableEl = renderData.competenciesTableEl = el.down(&#39;.cbl-grid-competencies&#39;),
            studentsTableEl = renderData.competenciesTableEl = el.down(&#39;.cbl-grid-main&#39;),

            competenciesById = renderData.competenciesById = {},
            competenciesRenderData = renderData.competencies,
            competenciesLength = competenciesRenderData.length, competencyIndex,
            competencyRenderData, competencyId, studentsById, competencySelector, progressRowEl, progressCellEl,

            competencyStudentsRenderData, studentsLength = renderData.students.length, studentIndex,
            studentRenderData, studentId;


        //
        // READ PHASE:
        //

        for (competencyIndex = 0; competencyIndex &lt; competenciesLength; competencyIndex++) {
            competencyRenderData = competenciesRenderData[competencyIndex];
            competencyId = competencyRenderData.competency.ID;
            competencyStudentsRenderData = competencyRenderData.students;
            studentsById = competencyRenderData.studentsById = {};
            competenciesById[competencyId] = competencyRenderData;

            competencySelector = &#39;[data-competency=&quot;&#39;+competencyId+&#39;&quot;]&#39;;
            competencyRenderData.progressRowEl = progressRowEl = studentsTableEl.down(&#39;.cbl-grid-progress-row&#39; + competencySelector);
            competencyRenderData.skillsRowEl = competenciesTableEl.down(&#39;.cbl-grid-skills-row&#39; + competencySelector);
            competencyRenderData.demonstrationsRowEl = studentsTableEl.down(&#39;.cbl-grid-skills-row&#39; + competencySelector);

            for (studentIndex = 0; studentIndex &lt; studentsLength; studentIndex++) {
                studentRenderData = competencyStudentsRenderData[studentIndex];
                studentId = studentRenderData.student.ID;
                studentsById[studentId] = studentRenderData;

                studentRenderData.progressCellEl = progressCellEl = progressRowEl.down(&#39;.cbl-grid-progress-cell[data-student=&quot;&#39;+studentId+&#39;&quot;]&#39;);
                studentRenderData.progressBarEl = progressCellEl.down(&#39;.cbl-grid-progress-bar&#39;);
                studentRenderData.progressLevelEl = progressCellEl.down(&#39;.cbl-grid-progress-level&#39;);
                studentRenderData.progressPercentEl = progressCellEl.down(&#39;.cbl-grid-progress-percent&#39;);
                studentRenderData.progressAverageEl = progressCellEl.down(&#39;.cbl-grid-progress-average&#39;);
            }
        }


        //
        // WRITE PHASE:
        //

        // syncRowHeights does a batch read followed by a batch write so it should remain as the first call in the write phase if possible
        Slate.cbl.Util.syncRowHeights(
            competenciesTableEl.select(&#39;thead tr, .cbl-grid-progress-row&#39;),
            studentsTableEl.select(&#39;thead tr, .cbl-grid-progress-row&#39;)
        );

    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-getRenderDataForCompetency'>    /**
</span>     * @protected
     * Gets the render object corresponding to the given competency from the render tree previously by
     * {@link #method-buildRenderData} and already loaded into {@link #config-data}. Properties
     * tracking the render state may be added to this object.
     *
     * @param {Slate.cbl.model.Competency} competency
     * @return {Object} competencyRenderData
     */
    getRenderDataForCompetency: function(competency) {
        return this.data.competencies[this.getCompetenciesStore().indexOf(competency)];
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-loadCompletions'>    /**
</span>     * @protected
     * Reads one or more new or updated completion model and apply them to the existing render
     *
     * @param {Slate.cbl.model.Completion/Slate.cbl.model.Completion[]} completions A new or updated completion model or array of models
     */
    loadCompletions: function(completions) {
        completions = Ext.isArray(completions) ? completions : [completions];

        var me = this,
            skillsStore = me.getSkillsStore(),
            demoSkillsStore = me.getDemonstrationSkillsStore(),
            competenciesById = me.getData().competenciesById,
            averageFormat = me.getAverageFormat(),
            progressFormat = me.getProgressFormat(),
            completionsLength = completions.length, completionIndex,
            needsFlush = false,
            completion, competencyData, competencyStudentData, progressCellEl, competencyId, studentId,
            count, average, level, renderedLevel,
            countDirty, averageDirty, levelDirty,
            percentComplete, demonstrationsRequired;

        for (completionIndex = 0; completionIndex &lt; completionsLength; completionIndex++) {
            completion = completions[completionIndex];
            competencyId = completion.get(&#39;CompetencyID&#39;);
            competencyData = competenciesById[competencyId];
            studentId = completion.get(&#39;StudentID&#39;);
            competencyStudentData = competencyData.studentsById[studentId];
            progressCellEl = competencyStudentData.progressCellEl;

            count = completion.get(&#39;demonstrationsComplete&#39;);
            average = completion.get(&#39;demonstrationsAverage&#39;);
            level = completion.get(&#39;currentLevel&#39;);
            renderedLevel = competencyStudentData.renderedLevel;

            countDirty = count != competencyStudentData.renderedCount;
            averageDirty = average != competencyStudentData.renderedAverage;
            levelDirty = level != renderedLevel;
            demonstrationsRequired = competencyData.competency.totalDemonstrationsRequired[completion.get(&#39;currentLevel&#39;)] || competencyData.competency.totalDemonstrationsRequired.default;

            if (countDirty || averageDirty) {
                percentComplete = 100 * (count || 0) / demonstrationsRequired;
                progressCellEl.toggleCls(&#39;is-average-low&#39;, percentComplete &gt;= 50 &amp;&amp; average !== null &amp;&amp; average &lt; (level + competencyData.competency.minimumAverageOffset));
            }

            if (countDirty) {
                competencyStudentData.progressBarEl.setStyle(&#39;width&#39;, isNaN(percentComplete) ? &#39;0&#39; : Math.round(percentComplete) + &#39;%&#39;);
                competencyStudentData.progressPercentEl.update(isNaN(percentComplete) ? &#39;&amp;mdash;&#39; : progressFormat(percentComplete));

                competencyStudentData.renderedCount = count;
            }

            if (averageDirty) {
                competencyStudentData.progressAverageEl.update(averageFormat(average));

                competencyStudentData.renderedAverage = average;
            }

            if (levelDirty) {
                progressCellEl.addCls(&#39;cbl-level-&#39;+level);

                if (renderedLevel) {
                    progressCellEl.removeCls(&#39;cbl-level-&#39;+renderedLevel);

                    me.removeDemonstrationSkills(demoSkillsStore.query([
                        new Ext.util.Filter({
                            property: &#39;StudentID&#39;,
                            value: studentId
                        }),
                        new Ext.util.Filter({
                            property: &#39;SkillID&#39;,
                            operator: &#39;in&#39;,
                            value: skillsStore.query(&#39;CompetencyID&#39;, competencyId).collect(&#39;ID&#39;, &#39;data&#39;)
                        })
                    ]).getRange(), false); // false to defer flushing demonstrations, we&#39;ll queue it for once at the end

                    needsFlush = true;

                    competencyStudentData.outgoingLevel = renderedLevel;
                }

                competencyStudentData.progressLevelEl.update(&#39;Y&#39; + level - 8);

                competencyStudentData.renderedLevel = level;
            }

            competencyStudentData.completion = completion.data;
        }

        if (needsFlush) {
            me.flushDemonstrations();
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-addDemonstrationSkills'>    /**
</span>     * @protected
     * Adds new demoonstration skills blocks
     *
     * @param {Slate.cbl.model.DemonstrationSkill[]} demoSkills An array of demonstration skills
     * @param {Boolean} [flush=true] True to call {@link #method-flushDemonstrations} after queing changes
     */
    addDemonstrationSkills: function(demoSkills, flush) {
        var me = this,
            renderData = me.getData();

        renderData.incomingDemonstrationSkills = (renderData.incomingDemonstrationSkills || []).concat(Ext.pluck(demoSkills, &#39;data&#39;));

        if (flush !== false) {
            me.flushDemonstrations();
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-updateDemonstrationSkills'>    /**
</span>     * @protected
     * Update already-rendered demonstration skill blocks
     *
     * @param {Slate.cbl.model.DemonstrationSkill[]} demoSkills An array of demonstration skills
     * @param {Boolean} [flush=true] True to call {@link #method-flushDemonstrations} after queing changes
     */
    updateDemonstrationSkills: function(demoSkills, flush) {
        var me = this,
            renderData = me.getData();

        renderData.updatedDemonstrationSkills = (renderData.updatedDemonstrationSkills || []).concat(Ext.pluck(demoSkills, &#39;data&#39;));

        if (flush !== false) {
            me.flushDemonstrations();
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-removeDemonstrationSkills'>    /**
</span>     * @protected
     * Remove already-rendered demonstration skills blocks
     *
     * @param {Slate.cbl.model.DemonstrationSkill[]} demoSkills An array of demonstration skills
     * @param {Boolean} [flush=true] True to call {@link #method-flushDemonstrations} after queing changes
     */
    removeDemonstrationSkills: function(demoSkills, flush) {
        var me = this,
            renderData = me.getData();

        renderData.removedDemonstrationSkills = (renderData.removedDemonstrationSkills || []).concat(Ext.pluck(demoSkills, &#39;data&#39;));

        if (flush !== false) {
            me.flushDemonstrations();
        }
    },

<span id='SlateDemonstrationsTeacher-view-StudentsProgressGrid-method-flushDemonstrations'>    /**
</span>     * @protected
     * Writes any pending changes to demonstrations to the DOM.
     *
     * This method must not trigger any reads from the DOM
     */
    flushDemonstrations: function() {
        var me = this,
            renderData = me.getData(),
            skillsById = renderData.skillsById,
            demoSkillsStore = me.getDemonstrationSkillsStore(),

            updatedDemonstrationSkills = renderData.updatedDemonstrationSkills || [],
            updatedDemonstrationSkillsLength = updatedDemonstrationSkills.length,

            incomingDemonstrationSkills = renderData.incomingDemonstrationSkills || [],
            incomingDemonstrationSkillsLength = incomingDemonstrationSkills.length,

            removedDemonstrationSkills = renderData.removedDemonstrationSkills || [],
            removedDemonstrationSkillsLength = removedDemonstrationSkills.length,

            skillDemonstrationIndex, skillDemonstration, unsortedDemonstrationSkills,

            competenciesRenderData = renderData.competencies,
            competenciesLength = competenciesRenderData.length, competencyIndex, competencyRenderData, competencyStudentsById,

            skillsRenderData, skillsLength, skillIndex, skillRenderData,
            skillDemonstrationsRequired, studentSkillDemonstrationsRequired,
            skillStudentsRenderData, skillStudentsLength, skillStudentIndex, skillStudentRenderData,
            skillDemonstrationBlocks, skillDemonstrationBlocksById, skillDemonstrationsChanged, oldSkillDemonstration, outgoingLevel,
            competencyStudentData,

            skillDemonstrationBlockEls, skillDemonstrationBlockEl,
            skillDemonstrationsOverridden, renderedOverridden,
            skillDemonstrationDemonstratedLevel, renderedDemonstrationLevel,
            skillDemonstrationOverride, renderedOverride,
            skillDemonstrationOverrideSpan, renderedOverrideSpan,
            skillDemonstrationDemonstrationID,

            competencyStudentLevelsFlushed = [], competencyStudentLevelsFlushedLength, competencyStudentLevelsIndex, competencyStudentCompletion;

        // nothing can be flushed if no skills are loaded yet
        if (!skillsById) {
            return;
        }


    	// sort any incoming skill demonstrations that can be into skills-&gt;students render objects
        unsortedDemonstrationSkills = [];

        for (skillDemonstrationIndex = 0; skillDemonstrationIndex &lt; incomingDemonstrationSkillsLength; skillDemonstrationIndex++) {
            skillDemonstration = incomingDemonstrationSkills[skillDemonstrationIndex];

            if (
                (skillRenderData = skillsById[skillDemonstration.SkillID]) &amp;&amp;
                (skillStudentRenderData = skillRenderData.studentsById[skillDemonstration.StudentID])
            ) {
                // discard demoSkills that match a loaded skill+student but aren&#39;t of the current level
                if (skillStudentRenderData.completion.currentLevel == skillDemonstration.TargetLevel) {
                    (skillStudentRenderData.incomingDemonstrationSkills || (skillStudentRenderData.incomingDemonstrationSkills = [])).push(skillDemonstration);
                }
            } else {
                unsortedDemonstrationSkills.push(skillDemonstration);
            }
        }

        renderData.incomingDemonstrationSkills = unsortedDemonstrationSkills;


    	// sort any updated skill demonstrations that can be into skills-&gt;students render objects
        unsortedDemonstrationSkills = [];

        for (skillDemonstrationIndex = 0; skillDemonstrationIndex &lt; updatedDemonstrationSkillsLength; skillDemonstrationIndex++) {
            skillDemonstration = updatedDemonstrationSkills[skillDemonstrationIndex];

            if (
                (skillRenderData = skillsById[skillDemonstration.SkillID]) &amp;&amp;
                (skillStudentRenderData = skillRenderData.studentsById[skillDemonstration.StudentID])
            ) {
                // discard demoSkills that match a loaded skill+student but aren&#39;t of the current level
                if (skillStudentRenderData.completion.currentLevel == skillDemonstration.TargetLevel) {
                    (skillStudentRenderData.updatedDemonstrationSkills || (skillStudentRenderData.updatedDemonstrationSkills = [])).push(skillDemonstration);
                }
            } else {
                unsortedDemonstrationSkills.push(skillDemonstration);
            }
        }

        renderData.updatedDemonstrationSkills = unsortedDemonstrationSkills;


    	// sort any removed skill demonstrations that can be into skills-&gt;students render objects
        unsortedDemonstrationSkills = [];

        for (skillDemonstrationIndex = 0; skillDemonstrationIndex &lt; removedDemonstrationSkillsLength; skillDemonstrationIndex++) {
            skillDemonstration = removedDemonstrationSkills[skillDemonstrationIndex];

            if (
                (skillRenderData = skillsById[skillDemonstration.SkillID]) &amp;&amp;
                (skillStudentRenderData = skillRenderData.studentsById[skillDemonstration.StudentID])
            ) {
                (skillStudentRenderData.removedDemonstrationSkills || (skillStudentRenderData.removedDemonstrationSkills = [])).push(skillDemonstration);
            } else {
                unsortedDemonstrationSkills.push(skillDemonstration);
            }
        }

        renderData.removedDemonstrationSkills = unsortedDemonstrationSkills;


        // consume all pending changes, generate new demonstrationBlocks arrays, and render them
        for (competencyIndex = 0; competencyIndex &lt; competenciesLength; competencyIndex++) {
            competencyRenderData = competenciesRenderData[competencyIndex];
            skillsRenderData = competencyRenderData.skills;
            competencyStudentsById = competencyRenderData.studentsById;

            if (!skillsRenderData) {
                continue;
            }

            for (skillIndex = 0, skillsLength = skillsRenderData.length; skillIndex &lt; skillsLength; skillIndex++) {
                skillRenderData = skillsRenderData[skillIndex];
                skillStudentsRenderData = skillRenderData.students;
                skillDemonstrationsRequired = skillRenderData.skill.DemonstrationsRequired;

                for (skillStudentIndex = 0, skillStudentsLength = skillStudentsRenderData.length; skillStudentIndex &lt; skillStudentsLength; skillStudentIndex++) {
                    skillStudentRenderData = skillStudentsRenderData[skillStudentIndex];
                    competencyStudentData = competencyStudentsById[skillStudentRenderData.student.ID];
                    skillDemonstrationBlocks = skillStudentRenderData.demonstrationBlocks;
                    skillDemonstrationBlocksById = skillStudentRenderData.demonstrationBlocksById || {};
                    updatedDemonstrationSkills = skillStudentRenderData.updatedDemonstrationSkills || [];
                    incomingDemonstrationSkills = skillStudentRenderData.incomingDemonstrationSkills || [];
                    removedDemonstrationSkills = skillStudentRenderData.removedDemonstrationSkills || [];
                    skillDemonstrationsChanged = false;
                    outgoingLevel = competencyStudentData.outgoingLevel;

                    if (skillDemonstrationsRequired[skillStudentRenderData.completion.currentLevel] !== undefined) {
                        studentSkillDemonstrationsRequired = skillDemonstrationsRequired[skillStudentRenderData.completion.currentLevel];
                    } else {
                        studentSkillDemonstrationsRequired = skillDemonstrationsRequired.default;
                    }

                    // apply updated skill demonstrations
                    if (updatedDemonstrationSkills.length) {
                        skillDemonstrationIndex = 0;
                        updatedDemonstrationSkillsLength = updatedDemonstrationSkills.length;
                        for (; skillDemonstrationIndex &lt; updatedDemonstrationSkillsLength; skillDemonstrationIndex++) {
                            skillDemonstration = updatedDemonstrationSkills[skillDemonstrationIndex];
                            oldSkillDemonstration = skillDemonstrationBlocksById[skillDemonstration.ID];

                            if (oldSkillDemonstration) {
                                if (oldSkillDemonstration !== skillDemonstration) {
                                    Ext.apply(oldSkillDemonstration, skillDemonstration);
                                }
                                skillDemonstrationsChanged = true;
                            } else {
                                incomingDemonstrationSkills.push(skillDemonstration);
                            }
                        }
                        skillStudentRenderData.updatedDemonstrationSkills = null;
                    }

                    // append any incoming skill demonstrations
                    if (incomingDemonstrationSkills.length) {
                        skillDemonstrationBlocks = skillDemonstrationBlocks.concat(skillStudentRenderData.incomingDemonstrationSkills);
                        skillStudentRenderData.incomingDemonstrationSkills = null;
                        skillDemonstrationsChanged = true;
                    }

                    // delete removed skill demonstrations
                    if (removedDemonstrationSkills.length) {
                        skillDemonstrationIndex = 0;
                        removedDemonstrationSkillsLength = removedDemonstrationSkills.length;
                        for (; skillDemonstrationIndex &lt; removedDemonstrationSkillsLength; skillDemonstrationIndex++) {
                            Ext.Array.remove(skillDemonstrationBlocks, skillDemonstrationBlocksById[removedDemonstrationSkills[skillDemonstrationIndex].ID]);
                        }
                        skillStudentRenderData.removedDemonstrationSkills = null;
                        skillDemonstrationsChanged = true;
                    }

                    // if demonstrations have changed, prepare new blocks array and patch the DOM
                    if (skillDemonstrationsChanged) {
                        skillDemonstrationBlocks = Slate.cbl.Util.sortDemonstrations(skillDemonstrationBlocks, studentSkillDemonstrationsRequired);
                        Slate.cbl.Util.padArray(skillDemonstrationBlocks, studentSkillDemonstrationsRequired);
                        skillStudentRenderData.demonstrationBlocks = skillDemonstrationBlocks;
                        skillDemonstrationsOverridden = false;

                        // reset block index
                        skillDemonstrationBlocksById = skillStudentRenderData.demonstrationBlocksById = {};

                        skillDemonstrationBlockEls = skillStudentRenderData.demonstrationBlockEls;
                        for (skillDemonstrationIndex = 0; skillDemonstrationIndex &lt; studentSkillDemonstrationsRequired; skillDemonstrationIndex++) {
                            skillDemonstration = skillDemonstrationBlocks[skillDemonstrationIndex];
                            skillDemonstrationDemonstratedLevel = skillDemonstration.DemonstratedLevel;
                            skillDemonstrationOverride = skillDemonstration.Override;
                            skillDemonstrationOverrideSpan = skillDemonstrationOverride ? studentSkillDemonstrationsRequired - skillDemonstrationIndex : undefined;
                            skillDemonstrationDemonstrationID = skillDemonstration.DemonstrationID;

                            skillDemonstrationBlockEl = skillDemonstrationBlockEls.item(skillDemonstrationIndex);
                            renderedDemonstrationLevel = skillDemonstrationBlockEl.renderedDemonstrationLevel;
                            renderedOverridden = skillDemonstrationBlockEl.renderedOverridden;
                            renderedOverride = skillDemonstrationBlockEl.renderedOverride;
                            renderedOverrideSpan = skillDemonstrationBlockEl.renderedOverrideSpan;

                            // apply overridden class to all blocks following an override block
                            if (renderedOverridden != skillDemonstrationsOverridden) {
                                skillDemonstrationBlockEl.renderedOverridden = skillDemonstrationsOverridden;

                                if (skillDemonstrationsOverridden) {
                                    skillDemonstrationBlockEl.addCls(&#39;cbl-grid-demo-overridden cbl-grid-demo-counted&#39;);
                                    skillDemonstrationBlockEl.update(&#39;O&#39;);
                                    console.log(&quot;%o.addCls(&#39;cbl-grid-demo-overridden&#39;)&quot;, skillDemonstrationBlockEl.dom);

                                    continue; // an overridden block doesn&#39;t need any further updates because it&#39;ll be hidden
                                } else if (renderedOverridden) {
                                    skillDemonstrationBlockEl.removeCls(&#39;cbl-grid-demo-overridden cbl-grid-demo-counted&#39;);
                                    skillDemonstrationBlockEl.update(&#39;&#39;);
                                    console.log(&quot;%o.removeCls(&#39;cbl-grid-demo-overridden&#39;)&quot;, skillDemonstrationBlockEl.dom);
                                }
                            }

                            skillDemonstrationsOverridden = skillDemonstrationsOverridden || skillDemonstrationOverride;

                            // apply override class to an override block
                            if (renderedOverride != skillDemonstrationOverride) {
                                skillDemonstrationBlockEl.renderedOverride = skillDemonstrationOverride;

                                if (skillDemonstrationOverride) {
                                    skillDemonstrationBlockEl.addCls(&#39;cbl-grid-override&#39;);
                                } else if (renderedOverride) {
                                    skillDemonstrationBlockEl.removeCls(&#39;cbl-grid-override&#39;);
                                }
                            }

                            // apply override span
                            if (renderedOverrideSpan != skillDemonstrationOverrideSpan) {
                                skillDemonstrationBlockEl.renderedOverrideSpan = skillDemonstrationOverrideSpan;

                                if (skillDemonstrationOverrideSpan) {
                                    skillDemonstrationBlockEl.addCls(&#39;cbl-grid-span-&#39; + skillDemonstrationOverrideSpan);
                                } else if (renderedOverrideSpan) {
                                    skillDemonstrationBlockEl.removeCls(&#39;cbl-grid-span-&#39; + renderedOverrideSpan);
                                }
                            }

                            // normalize level to output code
                            if (skillDemonstrationOverride) {
                                skillDemonstrationDemonstratedLevel = &#39;O&#39;; // letter O for override
                            } else if (skillDemonstrationDemonstratedLevel === 0) {
                                skillDemonstrationDemonstratedLevel = &#39;M&#39;;
                            }

                            // apply demonstrated level change
                            if (renderedDemonstrationLevel !== skillDemonstrationDemonstratedLevel) {
                                skillDemonstrationBlockEl.renderedDemonstrationLevel = skillDemonstrationDemonstratedLevel;

                                if (renderedDemonstrationLevel === undefined) {
                                    skillDemonstrationBlockEl.removeCls(&#39;cbl-grid-demo-empty&#39;);
                                } else if (skillDemonstrationDemonstratedLevel === undefined) {
                                    skillDemonstrationBlockEl.addCls(&#39;cbl-grid-demo-empty&#39;);
                                }

                                if (renderedDemonstrationLevel === &#39;M&#39;) {
                                    skillDemonstrationBlockEl.removeCls(&#39;cbl-grid-demo-uncounted&#39;);
                                } else if (skillDemonstrationDemonstratedLevel === &#39;M&#39;) {
                                    skillDemonstrationBlockEl.addCls(&#39;cbl-grid-demo-uncounted&#39;);
                                }

                                if (skillDemonstrationDemonstratedLevel &amp;&amp; skillDemonstrationDemonstratedLevel != &#39;M&#39;) {
                                    skillDemonstrationBlockEl.addCls(&#39;cbl-grid-demo-counted&#39;);
                                } else if (renderedDemonstrationLevel) {
                                    skillDemonstrationBlockEl.removeCls(&#39;cbl-grid-demo-counted&#39;);
                                }

                                skillDemonstrationBlockEl.update(skillDemonstrationDemonstratedLevel === undefined ? &#39;&#39; : skillDemonstrationDemonstratedLevel);

                            }

                            // apply demo ID change
                            if (skillDemonstrationBlockEl.renderedDemonstrationId != skillDemonstrationDemonstrationID) {
                                skillDemonstrationBlockEl.renderedDemonstrationId = skillDemonstrationDemonstrationID;
                                skillDemonstrationBlockEl.set({&#39;data-demonstration&#39;: skillDemonstrationDemonstrationID || &#39;&#39;});
                            }

                            // add reference to index
                            skillDemonstrationBlocksById[skillDemonstration.ID] = skillDemonstration;
                        }
                    }

                    // apply changed target level
                    if (outgoingLevel) {
                        skillStudentRenderData.demonstrationsCellEl.removeCls(&#39;cbl-level-&#39;+outgoingLevel).addCls(&#39;cbl-level-&#39;+competencyStudentData.renderedLevel);
                        Ext.Array.include(competencyStudentLevelsFlushed, competencyStudentData);
                    }
                }
            }
        }

        // remove outgoingLevel flag on any flushed student competencies and trigger demo reload
        competencyStudentLevelsIndex = 0;
        competencyStudentLevelsFlushedLength = competencyStudentLevelsFlushed.length;
        for (; competencyStudentLevelsIndex &lt; competencyStudentLevelsFlushedLength; competencyStudentLevelsIndex++) {
            competencyStudentData = competencyStudentLevelsFlushed[competencyStudentLevelsIndex];
            competencyStudentCompletion = competencyStudentData.completion;
            competencyStudentData.outgoingLevel = null;

            demoSkillsStore.loadByStudentsAndCompetencies(competencyStudentCompletion.StudentID, competencyStudentCompletion.CompetencyID);
        }
    }
}, function(Class) {
    //&lt;debug&gt;
    var monitoredMethods = [&#39;refresh&#39;, &#39;finishRefresh&#39;, &#39;syncRowHeights&#39;, &#39;buildRenderData&#39;, &#39;flushDemonstrations&#39;];

    Ext.Array.each(monitoredMethods, function(functionName) {
        var origFn = Class.prototype[functionName];

        Class.prototype[functionName] = function() {
            var timeLabel = this.id + &#39;.&#39; + functionName,
                ret;

            console.groupCollapsed(&#39;%o.%s(%o) called from %o&#39;, this.id, functionName, arguments, arguments.callee.caller);
            console.time(timeLabel);

            ret = origFn.apply(this, arguments);

            console.timeEnd(timeLabel);
            console.groupEnd();

            return ret;
        };
    });
    //&lt;/debug&gt;
});</pre>
</body>
</html>

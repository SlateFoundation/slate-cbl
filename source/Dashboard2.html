<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;SlateDemonstrationsStudent.controller.Dashboard&#39;, {
    extend: &#39;Ext.app.Controller&#39;,


    // entry points
    control: {
        dashboardCt: {
            render: &#39;onDashboardCtRender&#39;
        },
        competencyCard: {
            democellclick: &#39;onDemoCellClick&#39;
        }
    },


   // controller configuration
    views: [
        &#39;Dashboard&#39;,
        &#39;ContentAreaStatus&#39;,
        &#39;RecentProgress&#39;,
        &#39;OverviewWindow&#39;
    ],


    refs: {
        dashboardCt: {
            selector: &#39;slate-demonstrations-student-dashboard&#39;,
            autoCreate: true,

            xtype: &#39;slate-demonstrations-student-dashboard&#39;
        },
        contentAreaStatusCmp: {
            selector: &#39;slate-demonstrations-student-contentareastatus&#39;,
            autoCreate: true,

            xtype: &#39;slate-demonstrations-student-contentareastatus&#39;
        },
        recentProgressCmp: {
            selector: &#39;slate-demonstrations-student-recentprogress&#39;,
            autoCreate: true,

            xtype: &#39;slate-demonstrations-student-recentprogress&#39;
        },
        competencyCard: &#39;slate-demonstrations-student-competencycard&#39;
    },


    // controller templates method overrides
    onLaunch: function () {
        var siteEnv = window.SiteEnvironment || {},
            cblStudentId = (siteEnv.cblStudent || {}).ID,
            cblContentArea = siteEnv.cblContentArea || {},
            dashboardCt, contentAreaStatusCmp, recentProgressCmp;

        // fetch component instances
        dashboardCt = this.getDashboardCt();
        contentAreaStatusCmp = this.getContentAreaStatusCmp();
        recentProgressCmp = this.getRecentProgressCmp();

        // configure content area status
        contentAreaStatusCmp.setContentAreaTitle(cblContentArea.Title);

        // configure recent progress component with any available embedded data
        if (cblStudentId) {
            recentProgressCmp.setStudentId(cblStudentId);
        }

        if (cblContentArea) {
            recentProgressCmp.setContentAreaId(cblContentArea.ID);
        }

        // configure dashboard with any available embedded data
        if (cblStudentId) {
            dashboardCt.setStudentId(cblStudentId);
        }

        if (siteEnv.cblCompetencies) {
            dashboardCt.getCompetenciesStore().loadData(siteEnv.cblCompetencies);
        }

        // render components
        Ext.suspendLayouts();
        contentAreaStatusCmp.render(&#39;slateapp-viewport&#39;);
        recentProgressCmp.render(&#39;slateapp-viewport&#39;);
        dashboardCt.render(&#39;slateapp-viewport&#39;);
        Ext.resumeLayouts(true);
    },


    // event handlers
    onDashboardCtRender: function(dashboardCt) {
        var studentId = dashboardCt.getStudentId(),
            competenciesStore = dashboardCt.getCompetenciesStore(),
            contentAreaStatusCmp = this.getContentAreaStatusCmp();

        if (!studentId || !competenciesStore.isLoaded()) { // TODO: check if competencies store is loaded instead
            return;
        }

        dashboardCt.setCompetenciesStatus(&#39;loading&#39;);

        dashboardCt.getCompletionsStore().loadByStudentsAndCompetencies(studentId, competenciesStore.collect(&#39;ID&#39;), {
            callback: function(completions) {
                var minLevel = Infinity,
                    totalRequired = 0,
                    totalMissed = 0,
                    totalComplete = 0,
                    averageValues = [],
                    growthValues = [],
                    cardConfigs = [],
                    completionsLength = completions.length,
                    completionIndex = 0,
                    completion, lowestCompletion, average, growth;

                for (; completionIndex &lt; completionsLength; completionIndex++) {
                    completion = completions[completionIndex];

                    cardConfigs.push({
                        competency: competenciesStore.getById(completion.get(&#39;CompetencyID&#39;)),
                        completion: completion,
                        autoEl: &#39;li&#39;
                    });

                    // only use completions for lowest incomplete level for aggregate figures
                    lowestCompletion = completion.get(&#39;lowest&#39;);

                    if (lowestCompletion === false) {
                        // this completion isn&#39;t at the lowest level but one at that level isn&#39;t available
                        continue;
                    } else if (lowestCompletion) {
                        // switch to lowest-level completion
                        completion = lowestCompletion;
                    }

                    minLevel = Math.min(minLevel, completion.get(&#39;currentLevel&#39;));
                    totalRequired += completion.get(&#39;demonstrationsRequired&#39;);
                    totalMissed += completion.get(&#39;demonstrationsMissed&#39;);
                    totalComplete += completion.get(&#39;demonstrationsComplete&#39;);

                    if (growth = completion.get(&#39;growth&#39;)) {
                        growthValues.push(growth);
                    }

                    if (average = completion.get(&#39;demonstrationsAverage&#39;)) {
                        averageValues.push(average);
                    }
                }

                contentAreaStatusCmp.setLevel(minLevel);
                contentAreaStatusCmp.setPercentComplete(100 * totalComplete / totalRequired);
                contentAreaStatusCmp.setPercentMissed(100 * totalMissed / totalRequired);
                contentAreaStatusCmp.setMissed(totalMissed);
                contentAreaStatusCmp.setAverage(Ext.Array.sum(averageValues) / averageValues.length);
                contentAreaStatusCmp.setGrowth(Ext.Array.sum(growthValues) / growthValues.length);

                dashboardCt.add(cardConfigs);

                dashboardCt.setCompetenciesStatus(&#39;loaded&#39;);
            }
        });
    },

    onDemoCellClick: function(competencyCard, ev, targetEl) {
        this.getOverviewWindowView().create({
            ownerCmp: this.getDashboardCt(),
            autoShow: true,
            animateTarget: targetEl,

            competency: parseInt(targetEl.up(&#39;ul.cbl-skill-demos&#39;).up(&#39;li.cbl-competency-panel&#39;).getAttribute(&#39;data-competency&#39;), 10),
            skill: parseInt(targetEl.up(&#39;ul.cbl-skill-demos&#39;).getAttribute(&#39;data-skill&#39;), 10),
            student: this.getDashboardCt().getStudentId(),
            selectedDemonstration: parseInt(targetEl.getAttribute(&#39;data-demonstration&#39;), 10)
        });
    }
});
</pre>
</body>
</html>

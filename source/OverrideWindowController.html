<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;SlateDemonstrationsTeacher.view.OverrideWindowController&#39;, {
    extend: &#39;Ext.app.ViewController&#39;,
    alias: &#39;controller.slate-demonstrations-teacher-skill-overridewindow&#39;,
    requires: [
        &#39;Ext.window.Toast&#39;,

        &#39;Slate.API&#39;,

        &#39;Slate.cbl.model.Demonstration&#39;
    ],

    config: {
        // workaround for http://www.sencha.com/forum/showthread.php?290043-5.0.1-destroying-a-view-with-ViewController-attached-disables-listen-..-handlers
        id: &#39;slate-demonstrations-teacher-skill-overridewindow&#39;,
        control: {
           &#39;#&#39;: {
               beforeshow: &#39;onBeforeWindowShow&#39;
           },
            &#39;button[action=submit]&#39;: {
                click: &#39;onSubmitClick&#39;
            }
        },

        listen: {
        }
    },


    toastTitleTpl: [
        &#39;Standard Override Saved&#39;
    ],

    toastBodyTpl: [
        &#39;Overrode&#39;,
        &#39; &lt;strong&gt;{standard.Code}&lt;/strong&gt;&#39;,
        &#39; for&#39;,
        &#39; &lt;strong&gt;{student.FullName}.&lt;/strong&gt;&#39;
    ],


    // workaround for http://www.sencha.com/forum/showthread.php?290043-5.0.1-destroying-a-view-with-ViewController-attached-disables-listen-..-handlers
    applyId: function(id) {
        return Ext.id(null, id);
    },


    // template methods
    onBeforeWindowShow: function(overrideWindow) {
        var me = this,
            student = overrideWindow.getStudent(),
            standard = overrideWindow.getStandard(),
            summaryCmp = me.lookupReference(&#39;summary&#39;);

        if (student.isLoading()) {
            // framework will append our callback to the existing operation if the model is already loading
            student.load({
                callback: function() {
                    me.init(overrideWindow);
                }
            });
            return;
        }

        if (standard.isLoading()) {
            // framework will append our callback to the existing operation if the model is already loading
            standard.load({
                callback: function() {
                    me.init(overrideWindow);
                }
            });
            return;
        }

        summaryCmp.update({
            student: student.getData(),
            standard: standard.getData()
        });
    },


    // event handlers
    onSubmitClick: function() {
        var me = this,
            overrideWindow = me.getView(),
            student = overrideWindow.getStudent(),
            standard = overrideWindow.getStandard(),
            demonstration = Ext.create(&#39;Slate.cbl.model.Demonstration&#39;, {
                Class: &#39;Slate\\CBL\\Demonstrations\\OverrideDemonstration&#39;,
                StudentID: student.getId(),
                Skills: [
                    {
                        SkillID: standard.getId(),
                        Override: 1
                    }
                ],
                Comments: me.lookupReference(&#39;commentsField&#39;).getValue()
            });

        overrideWindow.setLoading(&#39;Submitting override&amp;hellip;&#39;);
        demonstration.save({
            callback: function(record, operation, success) {
                var tplData;

                if (success) {
                    tplData = {
                        student: student.getData(),
                        standard: standard.getData()
                    };

                    Ext.toast(
                        Ext.XTemplate.getTpl(me, &#39;toastBodyTpl&#39;).apply(tplData),
                        Ext.XTemplate.getTpl(me, &#39;toastTitleTpl&#39;).apply(tplData)
                    );

                    overrideWindow.close();

                    Slate.API.fireEvent(&#39;demonstrationsave&#39;, demonstration);
                } else {
                    overrideWindow.setLoading(false);

                    Ext.Msg.show({
                        title: &#39;Failed to apply override&#39;,
                        message: operation.getError() || &#39;Please backup your work to another application and report this to your technical support contact&#39;,
                        buttons: Ext.Msg.OK,
                        icon: Ext.Msg.ERROR
                    });
                }
            }
        });
    }
});</pre>
</body>
</html>

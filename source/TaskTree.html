<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;SlateTasksStudent.view.TaskTree&#39;, {
    extend: &#39;Slate.cbl.widget.SimplePanel&#39;,
    xtype: &#39;slatetasksstudent-tasktree&#39;,
    requires: [
        &#39;SlateTasksStudent.view.TaskFiltersMenu&#39;,

        /* global Slate */
        &#39;Slate.cbl.model.tasks.Task&#39;
    ],


    config: {
        store: null,
        readOnly: false
    },


    title: &#39;Current Tasks&#39;,
    cls: &#39;slate-tasktree&#39;,

    tools: [{
        text: &#39;Filter&#39;,
        menu: {
            xtype: &#39;slatetasksstudent-taskfiltersmenu&#39;
        }
    }],

    listeners: {
        scope: &#39;this&#39;,
        click: {
            fn: &#39;onTreeClick&#39;,
            element: &#39;el&#39;
        }
    },

    tpl: [
        &#39;&lt;tpl if=&quot;values.length == 0&quot;&gt;&#39;,
        &#39;    &lt;div class=&quot;empty-text&quot;&gt;No tasks found&lt;/div&gt;&#39;,
        &#39;&lt;tpl else&gt;&#39;,
        &#39;    &lt;ul class=&quot;slate-tasktree-list&quot;&gt;&#39;,

        &#39;        &lt;tpl for=&quot;.&quot;&gt;&#39;,
        &#39;            &lt;li class=&quot;slate-tasktree-item &lt;tpl if=&quot;subTasks.length&quot;&gt;has-subtasks&lt;/tpl&gt; slate-tasktree-status-{[ this.getDueStatusCls(values.task) ]}&quot; data-id=&quot;{task.ID}&quot;&gt;&#39;,

        &#39;                &lt;div class=&quot;flex-ct&quot;&gt;&#39;,
        &#39;                    &lt;div class=&quot;slate-tasktree-nub &lt;tpl if=&quot;subTasks.length&quot;&gt;is-clickable&lt;/tpl&gt;&quot;&gt;&lt;/div&gt;&#39;, // TODO: ARIA it up
        &#39;                    &lt;div class=&quot;slate-tasktree-data&quot;&gt;&#39;,
        &#39;                        &lt;div class=&quot;slate-tasktree-category&quot;&gt;{task.SectionTitle}&lt;/div&gt;&#39;,
        &#39;                        &lt;div class=&quot;slate-tasktree-text&quot;&gt;&#39;,
        &#39;                            &lt;div class=&quot;slate-tasktree-title&quot;&gt;{task.Title}&lt;/div&gt;&#39;,
        &#39;                            &lt;div class=&quot;slate-tasktree-status &lt;tpl if=&quot;!this.getStatusDate(values.task)&quot;&gt;slate-tasktree-nodate&lt;/tpl&gt;&quot;&gt;{[ this.getStatusString(values.task.TaskStatus) ]}&lt;/div&gt;&#39;,
        &#39;                            &lt;div class=&quot;slate-tasktree-date&quot;&gt;{[ this.getStatusDate(values.task) ]}&lt;/div&gt;&#39;,
        &#39;                        &lt;/div&gt;&#39;,
        &#39;                    &lt;/div&gt;&#39;,
        &#39;                &lt;/div&gt;&#39;,

        &#39;                &lt;tpl if=&quot;subTasks.length&quot;&gt;&#39;,
        &#39;                    &lt;ul class=&quot;slate-tasktree-sublist&quot;&gt;&#39;,

        &#39;                        &lt;tpl for=&quot;subTasks&quot;&gt;&#39;,
        &#39;                            &lt;li class=&quot;slate-tasktree-item slate-tasktree-status-{[ this.getDueStatusCls(values) ]}&quot; data-id=&quot;{ID}&quot;&gt;&#39;,

        &#39;                                &lt;div class=&quot;flex-ct&quot;&gt;&#39;,
        &#39;                                    &lt;div class=&quot;slate-tasktree-nub&quot;&gt;&lt;/div&gt;&#39;,
        &#39;                                    &lt;div class=&quot;slate-tasktree-data&quot;&gt;&#39;,
        &#39;                                        &lt;div class=&quot;slate-tasktree-text&quot;&gt;&#39;,
        &#39;                                            &lt;div class=&quot;slate-tasktree-title&quot;&gt;{Title}&lt;/div&gt;&#39;,
        &#39;                                            &lt;div class=&quot;slate-tasktree-status&quot;&gt;{[ this.getStatusString(values.TaskStatus) ]}&lt;/div&gt;&#39;,
        &#39;                                            &lt;div class=&quot;slate-tasktree-date&lt;tpl if=&quot;!values.DueDate&quot;&gt;-null&lt;/tpl&gt;&quot;&gt;{[ this.getStatusDate(values) ]}&lt;/div&gt;&#39;,
        &#39;                                        &lt;/div&gt;&#39;,
        &#39;                                    &lt;/div&gt;&#39;,
        &#39;                                &lt;/div&gt;&#39;,

        &#39;                            &lt;/li&gt;&#39;,
        &#39;                        &lt;/tpl&gt;&#39;,

        &#39;                    &lt;/ul&gt;&#39;,
        &#39;                &lt;/tpl&gt;&#39;,

        &#39;            &lt;/li&gt;&#39;,
        &#39;        &lt;/tpl&gt;&#39;,
        &#39;    &lt;/ul&gt;&#39;,
        &#39;&lt;/tpl&gt;&#39;,
        {
            getStatusString: function(taskStatus) {
                return Slate.cbl.model.tasks.Task.statusStrings[taskStatus] || &#39;&#39;;
            },
            getStatusDate: function(taskData) {
                var taskStatus = taskData.TaskStatus,
                    taskDate;

                if (taskStatus === &#39;submitted&#39; || taskStatus === &#39;re-submitted&#39;) {
                    taskDate = taskData.Submitted;
                } else {
                    taskDate = taskData.DueDate;
                }

                return Ext.Date.dateFormat(taskDate, &#39;M d, Y&#39;);
            },
            getDueStatusCls: function(task) {
                return Slate.cbl.model.tasks.Task[task.IsLate ? &#39;lateStatusClasses&#39; : &#39;statusClasses&#39;][task.TaskStatus] || &#39;&#39;;
            }
        }
    ],


    // config handlers
    applyStore: function(store) {
        return Ext.StoreMgr.lookup(store);
    },

    updateStore: function(store, oldStore) {
        if (oldStore) {
            oldStore.un({
                beforeload: &#39;onBeforeStoreLoad&#39;,
                load: &#39;onStoreLoad&#39;,
                scope: this
            });
        }

        if (store) {
            store.on({
                beforeload: &#39;onBeforeStoreLoad&#39;,
                load: &#39;onStoreLoad&#39;,
                scope: this
            });
        }
    },


    // event handlers
    onBeforeStoreLoad: function() {
        this.addCls(&#39;is-loading&#39;);
        this.mask(&#39;Loading Tasks&#39;);
    },

    onStoreLoad: function() {
        this.refresh();
        this.removeCls(&#39;is-loading&#39;);
        this.unmask();
    },

    onTreeClick: function(ev, t) {
        var me = this,
            target = Ext.get(t),
            parentEl = target.up(&#39;.slate-tasktree-item&#39;);

        if (target.is(&#39;.slate-tasktree-nub.is-clickable&#39;)) {
            parentEl.toggleCls(&#39;is-expanded&#39;);
        } else if (parentEl) {
            me.fireEvent(&#39;itemclick&#39;, me, me.getStore().getById(parentEl.getAttribute(&#39;data-id&#39;)));
        }
    },


    // member methods
    refresh: function() {
        var me = this,
            store = me.getStore(),
            items = [],

            rootTasks = store.queryBy(function(task) {
                return !task.get(&#39;ParentTaskID&#39;);
            }),
            rootTasksLength = rootTasks.getCount(),
            rootTasksIndex = 0,
            rootTask, rootTaskId, subTasks;

        // build tree of top-level tasks and subtasks
        for (; rootTasksIndex &lt; rootTasksLength; rootTasksIndex++) {
            rootTask = rootTasks.getAt(rootTasksIndex);
            rootTaskId = rootTask.get(&#39;TaskID&#39;);

            subTasks = store.queryBy(function(task) { // eslint-disable-line no-loop-func
                return task.get(&#39;ParentTaskID&#39;) == rootTaskId &amp;&amp; !task.get(&#39;filtered&#39;);
            });

            if (subTasks.getCount() &gt; 0) {
                rootTask.set(&#39;filtered&#39;, false); // do not filter parent tasks that have unfiltered subtasks
            }

            if (!rootTask.get(&#39;filtered&#39;)) {
                items.push({
                    task: rootTask.getData(),
                    subTasks: Ext.Array.pluck(subTasks.getRange(), &#39;data&#39;)
                });
            }
        }

        // render markup
        me.setData(items);

        // sync heights for animated expansion
        me.syncSublistHeights();
    },

    syncSublistHeights: function() {
        var sublistEls, sublistElsLength, sublistElIndex = 0, sublistEl, sublistHeight,
            listItemEls, listItemElsLength, listItemElIndex,
            sublistHeights = [], sublistHeightsLength, sublistHeightIndex = 0;

        // READ PHASE: sum heights of items in each sublist
        sublistEls = this.el.query(&#39;.slate-tasktree-sublist&#39;, false);
        sublistElsLength = sublistEls.length;

        for (; sublistElIndex &lt; sublistElsLength; sublistElIndex++) {
            sublistEl = sublistEls[sublistElIndex];
            sublistHeight = 0;

            listItemEls = sublistEl.query(&#39;.slate-tasktree-item&#39;, false);
            listItemElsLength = listItemEls.length;
            listItemElIndex = 0;

            for (; listItemElIndex &lt; listItemElsLength; listItemElIndex++) {
                sublistHeight += listItemEls[listItemElIndex].getHeight();
            }

            sublistHeights.push({
                el: sublistEl,
                height: sublistHeight
            });
        }

        // WRITE PHASE: set heights of sublists to item sums
        sublistHeightsLength = sublistHeights.length;

        for (; sublistHeightIndex &lt; sublistHeightsLength; sublistHeightIndex++) {
            sublistHeight = sublistHeights[sublistHeightIndex];
            sublistHeight.el.setHeight(sublistHeight.height);
        }
    }
});
</pre>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;Slate.cbl.view.AttachmentsList&#39;, {
    extend: &#39;Ext.view.View&#39;,
    xtype: &#39;slate-attachmentslist&#39;,
    requires: [
        &#39;Slate.cbl.model.tasks.Attachment&#39;
    ],

    config: {
        editable: true,
        shareMethodMutable: true,
        statusMutable: true,

        shareMenu: null
    },

    autoEl: &#39;ul&#39;,
    componentCls: &#39;slate-attachmentslist&#39;,

    emptyText: &#39;&lt;span class=&quot;muted&quot;&gt;No attachments&lt;/span&gt;&#39;,

    itemSelector: &#39;.slate-attachmentslist-item&#39;,

    store: {
        model: &#39;Slate.cbl.model.tasks.Attachment&#39;
    },

    tpl: [
        &#39;&lt;tpl for=&quot;.&quot;&gt;&#39;,
            &#39;&lt;li class=&quot;slate-attachmentslist-item&#39;,
                &#39;&lt;tpl if=&quot;kind&quot;&gt; slate-attachment-{kind}&lt;/tpl&gt;&#39;,
                &#39;&lt;tpl if=&quot;ShareMethod&quot;&gt; slate-attachment-{ShareMethod}&lt;/tpl&gt;&#39;,
                &#39;&lt;tpl if=&quot;Status == &amp;quot;removed&amp;quot;&quot;&gt; removed&lt;/tpl&gt;&#39;,
            &#39;&quot;&gt;&#39;,
                &#39;&lt;span class=&quot;slate-attachment-title&quot;&gt;&lt;a href=&quot;{[this.getURL(values)]}&quot; target=_blank&gt;{title}&lt;/a&gt;&lt;tpl if=&quot;Status == &amp;quot;removed&amp;quot;&quot;&gt;&lt;i&gt; (removed) &lt;/i&gt;&lt;/tpl&gt;&lt;/span&gt;&#39;,
                &#39;&lt;tpl if=&quot;isEditable&quot;&gt;&#39;,
                    &#39;&lt;tpl if=&quot;isPhantom&quot;&gt;&#39;,
                        &#39;&lt;tpl if=&quot;shareMethodMutable &amp;&amp; isPhantom &amp;&amp; this.isGoogleDoc(values)&quot;&gt;&#39;,
                            &#39;&lt;button class=&quot;plain&quot; action=&quot;settings&quot;&gt;&lt;i class=&quot;fa {[this.getShareMethodIcon(values.ShareMethod)]}&quot; title=&quot;{ShareMethod}&quot;&gt;&lt;/i&gt;&lt;/button&gt;&#39;,
                        &#39;&lt;/tpl&gt;&#39;,
                    &#39;&lt;/tpl&gt;&#39;,
                    &#39;&lt;tpl if=&quot;statusMutable &amp;&amp; Status == &amp;quot;normal&amp;quot;&quot;&gt;&#39;,
                        &#39;&lt;button class=&quot;plain&quot; action=&quot;toggle-status&quot; data-status=&quot;removed&quot;&gt;&lt;i class=&quot;fa fa-times-circle&quot;&gt;&lt;/i&gt;&lt;/button&gt;&#39;,
                    &#39;&lt;tpl elseif=&quot;statusMutable &amp;&amp; Status == &amp;quot;removed&amp;quot;&quot;&gt;&#39;,
                        &#39;&lt;button class=&quot;plain&quot; action=&quot;toggle-status&quot; data-status=&quot;normal&quot;&gt;&lt;i class=&quot;fa fa-undo&quot;&gt;&lt;/i&gt;&lt;/button&gt;&#39;,
                    &#39;&lt;/tpl&gt;&#39;,
                &#39;&lt;/tpl&gt;&#39;,
            &#39;&lt;/li&gt;&#39;,
        &#39;&lt;/tpl&gt;&#39;,
        {
            isGoogleDoc: function (values) {
                return values.Class == &#39;Slate\\CBL\\Tasks\\Attachments\\GoogleDriveFile&#39;;
            },

            getShareMethodIcon: function(method) {
                var icons = {
                    &#39;view-only&#39;: &#39;fa-eye&#39;,
                    duplicate: &#39;fa-copy&#39;,
                    collaborate: &#39;fa-users&#39;,
                    default: &#39;fa-gear&#39;
                };

                return icons[method] || icons.default;
            },

            getURL: function(values) {
                var fileType;

                if (this.isGoogleDoc(values) &amp;&amp; values.File &amp;&amp; values.File.DriveID) {
                    switch (values.File.Type) {
                        case &#39;drawing&#39;:
                        case &#39;spreadsheet&#39;:
                            fileType = values.File.Type + &#39;s&#39;;
                            break;

                        case &#39;presentation&#39;:
                        case &#39;document&#39;:
                            fileType = values.File.Type;
                            break;
                        default:
                            fileType = &#39;file&#39;;
                            break;
                    }
                    return &#39;https://docs.google.com/&#39;+fileType+&#39;/d/&#39;+values.File.DriveID;
                }

                return values.URL;
            }
        }
    ],

    prepareData: function(data, recordIndex, record) {
        var me = this,
            recordData = record.getData();

        return Ext.apply({}, recordData, {
            isPhantom: record.phantom,
            isEditable: me.getEditable(),
            statusMutable: me.getStatusMutable(),
            shareMethodMutable: me.getShareMethodMutable()
        });
    },

    updateEditable: function() {
        this.refreshView();
    },

    updateStatusMutable: function() {
        this.refreshView();
    },

    updateShareMethodMutable: function() {
        this.refreshView();
    },

    afterRender: function() {
        var me = this;

        me.callParent();

        if (me.el) {
            Ext.each(me.el.query(&#39;button&#39;, false), function(el) {
                el.setVisible(me.getEditable());
            });
        }

        me.el.on(&#39;tap&#39;, function(ev) {
            var btn = Ext.get(ev.getTarget(&#39;button&#39;)),
                action, record;

            if (!btn) {
                return;
            }

            action = btn.getAttribute(&#39;action&#39;);
            record = me.getRecord(btn.parent(me.getItemSelector()));

            if (action == &#39;settings&#39;) {
                me.getShareMethodMenu(record).showBy(btn, &#39;tl-tl&#39;, [-3, 0]);
            } else if (action == &#39;toggle-status&#39;) {
                if (record.phantom) {
                    me.getStore().remove(record);
                } else {
                    record.set(&#39;Status&#39;, btn.getAttribute(&#39;data-status&#39;));
                }
            }
        }, null, { delegate: &#39;button&#39; });
    },

    getShareMethodMenu: function(attachment) {
        var me = this,
            menu = me.getShareMenu();

        // create and set shareMenu config
        if (!menu) {
            menu = Ext.create(&#39;Ext.menu.Menu&#39;, {
                setValue: function(val) {
                    var item = this.down(&#39;menucheckitem[inputValue=&#39;+val+&#39;]&#39;);

                    if (item) {
                        item.setChecked(true);
                    }
                },
                bodyPadding: 3,
                defaults: {
                    xtype: &#39;menucheckitem&#39;,
                    group: &#39;ShareMethod&#39;,
                    handler: Ext.bind(me.onMenuItemSelect, me)
                },

                items: [{
                    iconCls: &#39;fa fa-eye&#39;,
                    text: &#39;View Only&#39;,
                    inputValue: &#39;view-only&#39;
                }, {
                    iconCls: &#39;fa fa-copy&#39;,
                    text: &#39;Duplicate&#39;,
                    inputValue: &#39;duplicate&#39;
                }, {
                    iconCls: &#39;fa fa-users&#39;,
                    text: &#39;Collaborate&#39;,
                    inputValue: &#39;collaborate&#39;
                }]
            });
            me.setShareMenu(menu);
        }

        menu.setConfig(&#39;attachment&#39;, attachment);
        menu.setValue(attachment.get(&#39;ShareMethod&#39;));

        return menu;
    },

    onMenuItemSelect: function(item) {
        var me = this,
            menu = me.getShareMenu();

        me.fireEvent(&#39;sharemethodchange&#39;, menu, menu.attachment, item, item.checked);
    }
});
</pre>
</body>
</html>

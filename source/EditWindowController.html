<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*jslint browser: true, undef: true *//*global Ext,Slate*/
Ext.define(&#39;SlateDemonstrationsTeacher.view.EditWindowController&#39;, {
    extend: &#39;Ext.app.ViewController&#39;,
    alias: &#39;controller.slate-demonstrations-teacher-demonstration-editwindow&#39;,
    requires: [
        &#39;Slate.API&#39;,

        &#39;Slate.cbl.field.LevelSlider&#39;,
        &#39;Slate.cbl.data.Skills&#39;,

        &#39;Ext.window.MessageBox&#39;,
        &#39;Ext.window.Toast&#39;,
        &#39;Ext.util.MixedCollection&#39;
    ],

    config: {
        control: {
            &#39;#&#39;: {
                show: &#39;onShow&#39;,
                beforeshow: &#39;onBeforeShow&#39;,
                loaddemonstration: &#39;onLoadDemonstration&#39;
            },
            &#39;combobox[name=StudentID]&#39;: {
                select: &#39;onStudentSelect&#39;
            },
            &#39;container[reference=competenciesTabPanel] &gt; container&#39;: {
                removed: &#39;onCompetencyCardRemoved&#39;
            },
            &#39;tabpanel[reference=competenciesTabPanel]&#39;: {
                tabchange: &#39;onCompetenciesTabChange&#39;
            },
            &#39;textfield[reference=competenciesSearchField]&#39;: {
                change: &#39;onCompetenciesSearchFieldChange&#39;,
                specialkey: &#39;onCompetenciesSearchFieldSpecialKey&#39;
            },
            &#39;gridpanel[reference=competenciesGrid]&#39;: {
                addclick: &#39;onCompetencyAddClick&#39;,
                rowclick: &#39;onCompetencyRowDoubleClick&#39;
            },
            &#39;button[action=submit]&#39;: {
                click: &#39;onSubmitClick&#39;
            }
        }
    },


    toastTitleTpl: [
        &#39;&lt;tpl if=&quot;wasPhantom&quot;&gt;&#39;,
            &#39;Demonstration Logged&#39;,
        &#39;&lt;tpl else&gt;&#39;,
            &#39;Demonstration Edited&#39;,
        &#39;&lt;/tpl&gt;&#39;
    ],

    toastBodyTpl: [
        &#39;&lt;tpl if=&quot;wasPhantom&quot;&gt;&#39;,
            &#39;&lt;tpl for=&quot;student&quot;&gt;&#39;,
                &#39;&lt;strong&gt;{FirstName} {LastName}&lt;/strong&gt;&#39;,
            &#39;&lt;/tpl&gt;&#39;,
            &#39; demonstrated&#39;,
            &#39; &lt;strong&gt;&#39;,
                &#39;{skills.length}&#39;,
                &#39; &lt;tpl if=&quot;skills.length == 1&quot;&gt;skill&lt;tpl else&gt;skills&lt;/tpl&gt;&#39;,
                &#39;.&#39;,
            &#39;&lt;/strong&gt;&#39;,
        &#39;&lt;tpl else&gt;&#39;,
            &#39;Updated&#39;,
            &#39; &lt;strong&gt;&#39;,
                &#39;{skills.length}&#39;,
                &#39; &lt;tpl if=&quot;skills.length == 1&quot;&gt;skill&lt;tpl else&gt;skills&lt;/tpl&gt;&#39;,
            &#39;&lt;/strong&gt;&#39;,
            &#39; demonstrated by&#39;,
            &#39;&lt;tpl for=&quot;student&quot;&gt;&#39;,
                &#39; &lt;strong&gt;&#39;,
                    &#39;{FirstName} {LastName}&#39;,
                    &#39;.&#39;,
                &#39;&lt;/strong&gt;&#39;,
            &#39;&lt;/tpl&gt;&#39;,
        &#39;&lt;/tpl&gt;&#39;
    ],


    // event handlers
    onBeforeShow: function(editWindow) {
        var defaultCompetency = editWindow.getDefaultCompetency();

        if (defaultCompetency) {
            this.addCompetency(defaultCompetency);
        }
    },

    onShow: function(editWindow) {
        var me = this,
            competenciesGrid = me.lookupReference(&#39;competenciesGrid&#39;),
            store = Ext.getStore(&#39;cbl-competencies&#39;);

        // load global competencies store the first time a window shows
        if (!store.isLoaded()) {
            competenciesGrid.setLoading(&#39;Loading competencies&amp;hellip;&#39;);

            store.on(&#39;load&#39;, function() {
                competenciesGrid.setLoading(false);
            }, me, { single: true });

            if (!store.isLoading()) {
                store.load();
            }
        }
    },

    onLoadDemonstration: function(editWindow, demonstration) {
        var me = this,
            competenciesGrid = me.lookupReference(&#39;competenciesGrid&#39;),
            competenciesStore = Ext.getStore(&#39;cbl-competencies&#39;),
            _restoreSavedSkills;

        // if loading a phantom, leave the form unloaded so empty fields aren&#39;t marked invalid
        if (demonstration.phantom) {
            return;
        }

        Ext.suspendLayouts();

        // if loading an existing demonstration, load it into the form immediately.
        me.lookupReference(&#39;form&#39;).loadRecord(demonstration);
        me.lookupReference(&#39;loadNextStudentCheck&#39;).setVisible(demonstration.phantom);

        competenciesGrid.setLoading(&#39;Loading competencies&amp;hellip;&#39;);

        // define closure for finishing this operation by loading already-saved skills into competencies grid
        _restoreSavedSkills = function() {
            var skills = demonstration.get(&#39;Skills&#39;) || [],
                skillsByCompetencyId = {},
                competenciesToLoad = [],
                skillsLength = skills.length, skillIndex = 0, demonstrationSkill, competencyId,
                _onCompetencyReady, _onFinished;

            _onCompetencyReady = function(competency, competencyCard) {
                var competencySkills = skillsByCompetencyId[competency.getId()],
                    competencySkillsLength = competencySkills.length,
                    competencySkillIndex = 0,
                    competencySkill;

                // remove competency from the queue
                Ext.Array.remove(competenciesToLoad, competency.getId());

                // load skills into competency
                for (; competencySkillIndex &lt; competencySkillsLength; competencySkillIndex++) {
                    competencySkill = competencySkills[competencySkillIndex];
                    competencyCard.down(&#39;slate-cbl-levelsliderfield{skill.getId()==&#39;+competencySkill.SkillID+&#39;}&#39;).setLevel(competencySkill.DemonstratedLevel);
                }

                // finish loading cycle when the queue is empty
                if (!competenciesToLoad.length) {
                    competenciesGrid.setLoading(false);
                    Ext.resumeLayouts(true);
                    me.scrollCompetenciesTabsToEnd();
                }
            };

            // group skills by competency and a queue of competencies to be loaded
            for (; skillIndex &lt; skillsLength; skillIndex++) {
                demonstrationSkill = skills[skillIndex];
                competencyId = demonstrationSkill.Skill.CompetencyID;

                if (competencyId in skillsByCompetencyId) {
                    skillsByCompetencyId[competencyId].push(demonstrationSkill);
                } else {
                    competenciesToLoad.push(competencyId);
                    skillsByCompetencyId[competencyId] = [demonstrationSkill];
                }
            }

            // load all competencies in the queue
            for (competencyId in skillsByCompetencyId) {
                if (skillsByCompetencyId.hasOwnProperty(competencyId)) {
                    me.addCompetency(competenciesStore.getById(competencyId), _onCompetencyReady, me, true); // true to insert sorted
                }
            }
        };

        // competencies grid must be loaded before restoring saved skills
        if (competenciesStore.isLoaded()) {
            _restoreSavedSkills();
        } else {
            competenciesStore.on(&#39;load&#39;, _restoreSavedSkills, me, { single: true });
        }
    },

    onStudentSelect: function(studentCombo, student) {
        this.getView().setTitle(&#39;Submit Evidence&#39; + ((student &amp;&amp; student.isModel) ? &#39; for &#39; + student.getDisplayName() : &#39;&#39;));
    },

    onCompetenciesSearchFieldChange: function(searchField, value) {
        this.updateCompetencyFilter(value);
    },

    onCompetenciesSearchFieldSpecialKey: function(searchField, ev) {
        var me = this,
            competenciesGrid = me.lookupReference(&#39;competenciesGrid&#39;),
            selectionModel = competenciesGrid.getSelectionModel();

        switch (ev.getKey()) {
            case ev.ENTER:
                if (selectionModel.getCount()) {
                    ev.stopEvent();
                    competenciesGrid.setLoading(&#39;Loading skills&amp;hellip;&#39;);
                    me.addCompetency(selectionModel.getLastSelected(), function() {
                        competenciesGrid.setLoading(false);
                    });
                }
                break;
            case ev.DOWN:
//            case ev.RIGHT:
                selectionModel.selectNext(false, true);
                ev.stopEvent();
                break;
            case ev.UP:
//            case ev.LEFT:
                selectionModel.selectPrevious(false, true);
                ev.stopEvent();
                break;
        }
    },

    onCompetencyAddClick: function(competenciesGrid, competency) {
        competenciesGrid.setLoading(&#39;Loading skills&amp;hellip;&#39;);
        this.addCompetency(competency, function() {
            competenciesGrid.setLoading(false);
        });
    },

    onCompetencyRowDoubleClick: function(competenciesGrid, competency) {
        competenciesGrid.setLoading(&#39;Loading skills&amp;hellip;&#39;);
        this.addCompetency(competency, function() {
            competenciesGrid.setLoading(false);
        });
    },

    onCompetencyCardRemoved: function(competencyCard, competenciesTabPanel) {
        if (competenciesTabPanel.destroying || competenciesTabPanel.destroyed) {
            return;
        }

        var me = this;

        Ext.suspendLayouts();

        me.updateCompetencyFilter();

        me.syncAddComptencyButtonVisibility();

        Ext.resumeLayouts(true);
    },

    onCompetenciesTabChange: function(tabPanel, newCard) {
        var me = this;

        if (newCard.reference == &#39;competenciesGrid&#39;) {
            Ext.defer(function() {
                me.lookupReference(&#39;competenciesSearchField&#39;).focus();
            }, 250);
        }
    },

    onSubmitClick: function(btn) {
        var me = this,
            editWindow = me.getView(),
            demonstration = editWindow.getDemonstration(),
            wasPhantom = demonstration.phantom,
            formPanel = me.lookupReference(&#39;form&#39;),
            studentField = formPanel.getForm().findField(&#39;StudentID&#39;),
            selectedStudent = studentField.getSelectedRecord(),
            activeSliders = me.lookupReference(&#39;competenciesTabPanel&#39;).query(&#39;[skill]{getLevel()!==null}&#39;),
            activeSlidersLength = activeSliders.length, activeSliderIndex = 0, activeSlider,
            skills = [];

        // compile entered skills into array
        for (; activeSliderIndex &lt; activeSlidersLength; activeSliderIndex++) {
            activeSlider = activeSliders[activeSliderIndex];
            skills.push({
                SkillID: activeSlider.skill.getId(),
                DemonstratedLevel: activeSlider.getLevel()
            });
        }

        if (!skills.length) {
            Ext.Msg.alert(&#39;Not ready to log demonstration&#39;, &#39;Select a competency level for at least one skill&#39;);
            return;
        }


        // persist to server
        editWindow.setLoading(&#39;Submitting demonstration&amp;hellip;&#39;);

        formPanel.updateRecord(demonstration);
        demonstration.set(&#39;Skills&#39;, skills);

        demonstration.save({
            callback: function(record, operation, success) {
                var studentsFieldStore,
                    tplData;

                if (success) {
                    tplData = {
                        wasPhantom: wasPhantom,
                        student: selectedStudent.getData(),
                        skills: skills
                    };

                    Ext.toast(
                        Ext.XTemplate.getTpl(me, &#39;toastBodyTpl&#39;).apply(tplData),
                        Ext.XTemplate.getTpl(me, &#39;toastTitleTpl&#39;).apply(tplData)
                    );

                    if (wasPhantom &amp;&amp; me.lookupReference(&#39;loadNextStudentCheck&#39;).checked &amp;&amp; !editWindow.destroying &amp;&amp; !editWindow.destroyed) {
                        // start a new demonstration
                        editWindow.setDemonstration({
                            Class: demonstration.get(&#39;Class&#39;)
                        });

                        studentsFieldStore = studentField.getStore();
                        studentField.select(studentsFieldStore.getAt(studentsFieldStore.indexOf(selectedStudent) + 1));

                        editWindow.setLoading(false);
                    } else {
                        editWindow.close();
                    }

                    Slate.API.fireEvent(&#39;demonstrationsave&#39;, demonstration);
                } else {
                    editWindow.setLoading(false);
                    Ext.Msg.show({
                        title: &#39;Failed to log demonstration&#39;,
                        message: operation.getError() || &#39;Please backup your work to another application and report this to your technical support contact&#39;,
                        buttons: Ext.Msg.OK,
                        icon: Ext.Msg.ERROR
                    });
                }
            }
        });
    },


    // protected methods
    addCompetency: function(competency, callback, scope, insertSorted) {
        var me = this,
            editWindow = me.getView(),
            competenciesStore = Ext.getStore(&#39;cbl-competencies&#39;),
            competenciesTabPanel = me.lookupReference(&#39;competenciesTabPanel&#39;),
            competenciesSearchField = me.lookupReference(&#39;competenciesSearchField&#39;),
            competencyCardConfig = {
                competency: competency,
                items: []
            },
            skillFieldsConfig = competencyCardConfig.items;

        // convert competency id to instance
        if (!competency.isModel) {
            // defer addCompetency until competencies store is loaded if necessary
            if (competenciesStore.isLoaded()) {
                competency = competenciesStore.getById(competency);
            } else {
                competenciesStore.on(&#39;load&#39;, function() {
                    me.addCompetency(competency, callback, scope, insertSorted);
                }, null, { single: true });

                return;
            }
        }


        competencyCardConfig.title = competency.get(&#39;Code&#39;);

        Slate.cbl.data.Skills.getAllByCompetency(competency, function(skills) {
            if (editWindow.destroying || editWindow.destroyed) {
                return;
            }

            var competencyCard, insertIndex;

            skills.each(function(skill) {
                skillFieldsConfig.push({
                    fieldLabel: skill.get(&#39;Descriptor&#39;),
                    skill: skill
                });
            });

            Ext.suspendLayouts();

            if (insertSorted) {
                // slightly hackey -- items is AbstractMixedCollection which doesn&#39;t have findInsertionIndex, but
                // findInsertionIndex is a public method on MixedCollection which directly extends its abstract
                // variant to add sorting methods
                insertIndex = Ext.util.MixedCollection.prototype.findInsertionIndex.call(competenciesTabPanel.items, competencyCardConfig, function(a, b) {
                    // the add competencies grid is always last
                    if (a.reference == &#39;competenciesGrid&#39;) {
                        return 1;
                    } else if (b.reference == &#39;competenciesGrid&#39;) {
                        return -1;
                    }

                    // sort by title -- this could be inaccurate if codes have numbers appended that are multiple digits but not zerofilled
                    return a.title.localeCompare(b.title);
                });
            } else {
                insertIndex = competenciesTabPanel.items.getCount() - 1;
            }

            competencyCard = competenciesTabPanel.insert(insertIndex, competencyCardConfig);
            competencyCard.down(&#39;#competencyDescription&#39;).update(competency.getData());
            competenciesTabPanel.setActiveItem(competencyCard);


            if (competenciesSearchField.isDirty()) {
                competenciesSearchField.reset(); // changing the value from dirty back to blank will trigger the change handler
            } else {
                me.updateCompetencyFilter(); // if the field was already blank the filter needs to be manually reset to remove the added competency
            }

            me.syncAddComptencyButtonVisibility();

            Ext.resumeLayouts(true);

            me.scrollCompetenciesTabsToEnd(); // must be called after resuming layouts

            Ext.callback(callback, scope, [competency, competencyCard]);
        });
    },

    scrollCompetenciesTabsToEnd: function() {
        var me = this,
            competenciesTabPanel = me.lookupReference(&#39;competenciesTabPanel&#39;),
            competenciesTabBar = competenciesTabPanel.getTabBar(),
            _doScroll = function() {
                competenciesTabBar.getLayout().overflowHandler.scrollToItem(competenciesTabPanel.items.last().tab);
            };

        if (competenciesTabBar.rendered) {
            setTimeout(_doScroll, 500);
        } else {
            competenciesTabBar.on(&#39;boxready&#39;, _doScroll, me, { single: true });
        }
    },

    updateCompetencyFilter: function(query) {
        var me = this,
            tabPanelItems = me.lookupReference(&#39;competenciesTabPanel&#39;).items,
            grid = me.lookupReference(&#39;competenciesGrid&#39;),
            store = grid.getStore(),
            groupingFeature = grid.getView().getFeature(&#39;grouping&#39;),
            isCompetencyAvailable = function(competency) {
                return !tabPanelItems.findBy(function(card) {
                    return card.competency === competency;
                });
            },
            regex;

        Ext.suspendLayouts();

        query = Ext.String.trim(query || me.lookupReference(&#39;competenciesSearchField&#39;).getValue());

        store.clearFilter(false);
        if (query) {
            regex =  Ext.String.createRegex(query, false, false);
            store.filterBy(function(competency) {
                return (
                    isCompetencyAvailable(competency) &amp;&amp; (
                        regex.test(competency.get(&#39;Code&#39;)) ||
                        regex.test(competency.get(&#39;Descriptor&#39;))
                    )
                );
            });

            if (store.getCount()) {
                groupingFeature.expandAll();
                grid.getSelectionModel().select(store.getAt(0), false, true);
            }
        } else {
            store.filterBy(isCompetencyAvailable);
            groupingFeature.collapseAll();
        }

        Ext.resumeLayouts(true);
    },

    syncAddComptencyButtonVisibility: function() {
        var me = this,
            tabPanel = me.lookupReference(&#39;competenciesTabPanel&#39;);

        tabPanel.getTabBar().setHidden(tabPanel.items.getCount() == 1);
    }
});</pre>
</body>
</html>

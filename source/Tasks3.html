<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;SlateTasksManager.controller.Tasks&#39;, {
    extend: &#39;Ext.app.Controller&#39;,
    requires: [
        &#39;Slate.API&#39;,
        &#39;Ext.window.Toast&#39;
    ],

    views: [
        &#39;TaskEditor&#39;,
        &#39;TasksManager&#39;,
        &#39;TaskDetails&#39;
    ],

    stores: [
        &#39;Tasks@Slate.cbl.store&#39;,
        &#39;ParentTasks&#39;,
        &#39;Skills@Slate.cbl.store&#39;
    ],

    models: [
        &#39;Task@Slate.cbl.model&#39;
    ],

    config: {
        refs: {
            tasksManager: {
                selector: &#39;slate-tasks-manager&#39;,
                autoCreate: true,

                xtype: &#39;slate-tasks-manager&#39;
            },

            taskEditor: {
                selector: &#39;slatetasksmanager-task-editor&#39;,
                autoCreate: true,

                xtype: &#39;slatetasksmanager-task-editor&#39;
            },
            taskDetails: &#39;slate-tasks-manager-details&#39;,
            taskEditorForm: &#39;slatetasksmanager-task-editor slate-modalform&#39;,
            skillsField: &#39;slate-skillsfield&#39;,
            attachmentsField: &#39;slate-tasks-attachmentsfield&#39;,
            taskStatusField: &#39;slatetasksmanager-task-editor #status&#39;
        }
    },

    control: {
        &#39;slate-tasks-manager toolbar button[action=delete]&#39;: {
            click: &#39;onDeleteTaskClick&#39;
        },
        &#39;slate-tasks-manager toolbar button[action=edit]&#39;: {
            click: &#39;onEditTaskClick&#39;
        },
        &#39;slate-tasks-manager toolbar button[action=create]&#39;: {
            click: &#39;onCreateTaskClick&#39;
        },
        &#39;slatetasksmanager-task-editor button[action=save]&#39;: {
            click: &#39;onSaveTaskClick&#39;
        },
        &#39;slatetasksmanager-task-editor slate-tasks-titlefield[clonable]&#39;: {
            select: &#39;onClonableTitleFieldSelect&#39;
        },
        tasksManager: {
            rowdblclick: &#39;onEditTaskClick&#39;,
            select: &#39;onTaskManagerRecordSelect&#39;
        }
    },

    onLaunch: function () {
        this.getTasksManager().render(&#39;slateapp-viewport&#39;);
    },

    onCreateTaskClick: function() {
        return this.editTask();
    },

    onEditTaskClick: function() {
        var me = this,
            selection = me.getTasksManager().getSelection()[0];

        if (!selection) {
            return Ext.Msg.alert(&#39;Edit Task&#39;, &#39;Nothing selected. Please select a task to edit.&#39;);
        }
        return me.editTask(selection);
    },

    onDeleteTaskClick: function() {
        var me = this,
            taskManager = me.getTasksManager(),
            selection = taskManager.getSelection()[0],
            title, message;

        if (!selection) {
            Ext.Msg.alert(&#39;Delete Task&#39;, &#39;Nothing selected. Please select a task to delete.&#39;);
            return;
        }

        title = &#39;Delete Task&#39;;
        message = &#39;Are you sure you want to delete this task? &lt;br&gt;&lt;strong&gt;&#39; + selection.get(&#39;Title&#39;) + &#39;&lt;/strong&gt;&#39;;
        Ext.Msg.confirm(title, message, function(response) {
            if (response === &#39;yes&#39;) {
                me.deleteTask(selection);
            }
        });
    },

    onSaveTaskClick: function() {
        return this.saveTask();
    },

    onClonableTitleFieldSelect: function(combo) {
        var me = this,
            record = combo.getSelectedRecord(),
            title = &#39;New Task&#39;,
            message = &#39;Do you want to clone this task?&lt;br&gt;&lt;strong&gt;&#39; + record.get(&#39;Title&#39;) + &#39;&lt;/strong&gt;&#39;;

        Ext.Msg.confirm(title, message, function(btnId) {
            if (btnId === &#39;yes&#39;) {
                me.cloneTask(record);
            }
        });
    },

    onTaskManagerRecordSelect: function() {
        this.showTaskDetails();
    },

    showTaskDetails: function(task) {
        var me = this,
            taskDetails = me.getTaskDetails(),
            taskManager = me.getTasksManager();

        if (!task &amp;&amp; !(task = taskManager.getSelection()[0])) {
            return;
        }

        taskDetails.setTask(task);
    },

    saveTask: function() {
        var me = this,
            form = me.getTaskEditorForm(),
            skillsField = me.getSkillsField(),
            attachmentsField = me.getAttachmentsField(),
            statusField = me.getTaskStatusField(),
            record = form.getRecord(),
            gridSelection = me.getTasksManager().getSelection()[0],
            errors;

        form.updateRecord(record);

        record.set({
            Status: statusField.getSubmitValue(),
            Skills: skillsField.getSkills(false), // returnRecords
            Attachments: attachmentsField.getAttachments(false) // returnRecords
        });

        errors = record.validate();

        if (errors.length) {
            Ext.each(errors.items, function(item) {
                var itemField = form.down(&#39;[name=&#39;+item.field +&#39;]&#39;);

                if (itemField) {
                    itemField.markInvalid(item.message);
                }
            });
            return;
        }

        record.save({
            success: function(rec) {
                me.getTaskEditor().close();
                me.getTasksStore().reload({
                    callback: function() {
                        // update task details window if record is updated.
                        if (gridSelection &amp;&amp; gridSelection.getId() === rec.getId()) {
                            me.getTaskDetails().updateTask(rec);
                        }
                    }
                });
                Ext.toast(&#39;Task succesfully saved!&#39;);
            }
        });
    },

    editTask: function(taskRecord) {
        var me = this,
            taskEditor = me.getTaskEditor();

        if (!taskRecord) {
            taskRecord = me.getTaskModel().create();
        }

        taskEditor.setTask(taskRecord);
        taskEditor.show();
    },

    deleteTask: function(taskRecord) {
        var store = this.getTasksStore();

        store.remove(taskRecord);
        store.sync();
    },

    cloneTask: function(taskRecord) {
        var me = this,
            taskCopy = taskRecord.copy(null);

        taskCopy.set({
            Title: taskCopy.get(&#39;Title&#39;) + &#39; Clone&#39;
        });

        me.editTask(taskCopy);
    }
});</pre>
</body>
</html>

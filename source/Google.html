<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;Slate.cbl.util.Google&#39;, {
    singleton: true,

    requires: [
        &#39;Ext.Promise&#39;,
        &#39;Ext.util.Cookies&#39;
    ],

    config: {
        tokenName: &#39;googleAppsToken&#39;,
        scope: &#39;https://www.googleapis.com/auth/drive&#39;,
        requiredAPIs: [
            &#39;auth2&#39;,
            &#39;client&#39;,
            &#39;picker&#39;
        ],
        apiIsLoaded: false,
        authenticatedUser: null
    },

    constructor: function(cfg) {
        this.initConfig(cfg || {});

        return this;
    },

    updateAuthenticatedUser: function(user) {
        if (user === null) {
            this.setToken(null);
        }
    },

    getToken: function() {
        return Ext.util.Cookies.get(this.getTokenName(), &#39;/&#39;);
    },

    setToken: function(token, expiration) {
        if (token === null) {
            expiration = new Date(0);
        }

        return Ext.util.Cookies.set(this.getTokenName(), token, expiration, &#39;/&#39;);
    },

    getDeveloperKey: function() {
        return SiteEnvironment &amp;&amp; SiteEnvironment.googleAppsDeveloperKey;
    },

    getClientId: function() {
        return SiteEnvironment &amp;&amp; SiteEnvironment.googleAppsClientId;
    },

    getGoogleAppsDomain: function() {
        return SiteEnvironment &amp;&amp; SiteEnvironment.googleAppsDomain || location.host;
    },

    verifyEmailAddress: function(email) {
        return email.match(new RegExp(&#39;^.+@&#39;+Slate.cbl.util.Google.getGoogleAppsDomain()+&#39;$&#39;));
    },

    initFilePicker: function() {
        var me = Slate.cbl.util.Google,
            token = me.getToken(),
            developerKey = me.getDeveloperKey();

        return new google.picker.PickerBuilder().
            addView(google.picker.ViewId.DOCS).
            setOAuthToken(token).
            setDeveloperKey(developerKey);
    },

    loadAPI: function() {
        var me = Slate.cbl.util.Google,
            exception = {},
            requiredAPIs = me.getRequiredAPIs().join(&#39;:&#39;);

        if (!gapi) {
            exception.error = &#39;Unable to find gapi, aborting.&#39;;
            throw exception;
        }

        return new Ext.Promise(function(resolve) {
            me.setApiIsLoaded(true);
            gapi.load(requiredAPIs, function() {
                gapi.auth2.init({
                    &#39;client_id&#39;: me.getClientId(),
                    &#39;hosted_domain&#39;: me.getGoogleAppsDomain()
                });

                resolve(arguments);
            });

        });
    },

    /*
    * Returns Ext.Promise object
    */
    authenticateUser: function() {
        var me = Slate.cbl.util.Google;

        return gapi.auth2.getAuthInstance().signIn({
            &#39;scope&#39;: me.getScope(),
            prompt: &#39;select_account&#39;
        }).
        then(me.onUserAuthenticated);
    },

    /*
    * Returns Ext.Promise object
    */
    onUserAuthenticated: function(response) {
        return new Ext.Promise(function(resolve, reject) {
            var me = Slate.cbl.util.Google,
                googleAppsDomain = me.getGoogleAppsDomain(),
                authResult = response.getAuthResponse();

            console.info(&#39;handleAuthResult(%o)&#39;, authResult);

            if (!authResult || authResult.error) {
                reject(authResult.error);
                return;
            }

            gapi.client.request({
                path: &#39;/drive/v3/about&#39;,
                params: {
                    fields: &#39;user&#39;
                }
            }).
            then(function(userProfileResponse) {
                console.info(&#39;loaded user&#39;, userProfileResponse.result);
                if (!userProfileResponse.result || !userProfileResponse.result.user || !me.verifyEmailAddress(userProfileResponse.result.user.emailAddress)) {
                    reject(&#39;Please sign in with an account under &#39; + googleAppsDomain);
                    return;
                }

                me.setToken(authResult.access_token, new Date(authResult.expires_at * 1000));
                me.setAuthenticatedUser(userProfileResponse.result.user);

                resolve(userProfileResponse);
            });
        });
    },

    /*
    * Returns Ext.Promise object
    */
    getGoogleFileOwnerEmail: function(file) {
        var me = Slate.cbl.util.Google,
            permissionId = me.getAuthenticatedUser().permissionId,
            fileId = file[google.picker.Document.ID];

        return gapi.client.request({
            path: &#39;/drive/v3/files/&#39;+fileId+&#39;/permissions/&#39;+permissionId,
            method: &#39;GET&#39;,
            params: {
                &#39;access_token&#39;: me.getToken(),
                fields: &#39;id,emailAddress&#39;
            }
        });
    },

    cloneGoogleFile: function(file) {
        var me = Slate.cbl.util.Google,
            googleAppsToken = me.getToken();

        return gapi.client.request({
            path: &#39;/drive/v3/files/&#39; + file[google.picker.Document.ID] + &#39;/copy&#39;,
            method: &#39;POST&#39;,
            params: {
                &#39;access_token&#39;: googleAppsToken,
                fields: &#39;id,name,webViewLink&#39;
            },
            body: {
                &#39;resource&#39;: { &#39;title&#39;: file[google.picker.Document.NAME] }
            }
        }).
        then(function(response) {
            if (response.error) {
                return Ext.Promise.reject(response);
            }

            return Ext.Promise.resolve({
                file: {
                    url: response.result.webViewLink,
                    name: response.result.name,
                    id: response.result.id
                },
                email: me.getAuthenticatedUser().emailAddress
            });
        });
    },

<span id='global-method-getUserFilePermissions'>    /**
</span>    * Get user file permission role (owner, writer, commenter, reader)
    * @param fileId string - Google Drive File ID
    * @param token string - Google API token, with Google Drive API scope, defaults to last token cached
    * @param permissionId string - Google User Permission ID, defaults to last authenticated user
    * Returns Promise
    */
    getUserFilePermissions: function(fileId, token, permissionId) {
        var me = Slate.cbl.util.Google,
            userPermissionId = permissionId || me.getAuthenticatedUser() &amp;&amp; me.getAuthenticatedUser().permissionId,
            accessToken = token || me.getToken(),
            roles = [
                &#39;reader&#39;,
                &#39;commenter&#39;,
                &#39;writer&#39;,
                &#39;owner&#39;
            ];

        return gapi.client.request({
            path: &#39;/drive/v3/files/&#39;+fileId+&#39;/permissions&#39;,
            method: &#39;GET&#39;,
            params: {
                &#39;access_token&#39;: accessToken
            }
        }).
        then(function(response) {
            var userPermission,
                permissions,
                i = 0;

            if (response.result &amp;&amp; response.result.error) {
                return Ext.Promise.reject(response.results.error.errors);
            }

            permissions = response.result.permissions;
            for (; i &lt; permissions.length; i++) {
                switch (permissions[i].type) {
                    case &#39;anyone&#39;:
                    case &#39;user&#39;:
                        if (permissions[i].id === userPermissionId
                            &amp;&amp; (!userPermission || roles.indexOf(permissions[i].role) &gt; roles.indexOf(userPermission))
                        ) {
                            userPermission = permissions[i].role;
                        }

                        break;

                    default:
                        break;
                }

                if (userPermission === roles[roles.length - 1]) {
                    continue;
                }
            }

            return Ext.Promise.resolve(userPermission);
        });
    }
});</pre>
</body>
</html>

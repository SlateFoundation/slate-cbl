Ext.define('Slate.cbl.admin.overrides.SettingsNavPanel',{override:'SlateAdmin.view.settings.NavPanel',initComponent:function(){var a=this;a.data=a.data.concat({href:'#settings/cbl/skills',text:'CBL Skills'});a.callParent(arguments)}});Ext.define('Slate.cbl.admin.model.Skill',{extend:'Ext.data.Model',requires:['Slate.proxy.Records','Ext.data.identifier.Negative'],idProperty:'ID',identifier:'negative',fields:[{name:'ID',type:'int',allowNull:!0},{name:'Class',type:'string',defaultValue:'Slate\\CBL\\Skill'},{name:'Created',type:'date',dateFormat:'timestamp',allowNull:!0},{name:'CreatorID',type:'int',allowNull:!0},{name:'RevisionID',type:'int',allowNull:!0},{name:'Modified',type:'date',dateFormat:'timestamp',allowNull:!0},{name:'ModifierID',type:'int',allowNull:!0},{name:'CompetencyID',type:'int'},{name:'Code',type:'string'},{name:'Descriptor',type:'string'},{name:'Statement',type:'string'},'DemonstrationsRequired'],proxy:{type:'slate-records',url:'/cbl/skills'}});Ext.define('Slate.cbl.admin.store.Skills',{extend:'Ext.data.Store',model:'Slate.cbl.admin.model.Skill',remoteSort:!0,pageSize:50});Ext.define('Slate.cbl.admin.view.skills.Grid',{extend:'Ext.grid.Panel',requires:['Ext.toolbar.Paging'],xtype:'cbl-admin-skills-grid',store:'Skills',height:'100%',dockedItems:[{xtype:'pagingtoolbar',store:'Skills',dock:'bottom',displayInfo:!0}],columns:{defaults:{flex:1},items:[{dataIndex:'Code',text:'Code'},{dataIndex:'Descriptor',text:'Descriptor',flex:5},{dataIndex:'Statement',text:'Statement',flex:5}]}});Ext.define('Slate.cbl.admin.view.skills.EvidenceRequirementsField',{extend:'Ext.form.FieldContainer',xtype:'cbl-admin-skills-evidencerequirementsfield',requires:['Ext.form.field.Number','Ext.layout.container.HBox'],layout:'hbox',fieldLabel:'',config:{level:'default',value:0},initComponent:function(){var a=this,b=a.getLevel();a.items=[{xtype:'numberfield',fieldLabel:b=='default'?'Default Level':'Level '+b,value:a.getValue(),minValue:0,listeners:{change:function(b,a){this.up('cbl-admin-skills-evidencerequirementsfield').setValue(a)}}}];if(b!=='default'){a.items.push({xtype:'button',cls:'glyph-danger',glyph:61526,text:'Remove',handler:function(){this.up('fieldcontainer').destroy()}})}a.callParent(arguments)}});Ext.define('Slate.cbl.admin.view.skills.Form',{extend:'Ext.form.Panel',xtype:'cbl-admin-skills-form',requires:['Ext.form.field.ComboBox','Ext.form.field.Display','Ext.form.field.Number','Ext.form.field.Text','Ext.form.field.TextArea','Ext.panel.Panel','Ext.toolbar.Fill','Slate.cbl.admin.view.skills.EvidenceRequirementsField'],disabled:!0,title:'Selected Skill',componentCls:'cbl-admin-skills-editor',bodyPadding:10,scrollable:'vertical',trackResetOnLoad:!0,defaults:{labelWidth:70,labelAlign:'right',anchor:'100%'},items:[{xtype:'displayfield',name:'Code',fieldLabel:'Code'},{xtype:'textareafield',name:'Descriptor',fieldLabel:'Descriptor',allowBlank:!1},{xtype:'textareafield',name:'Statement',fieldLabel:'Statement',allowBlank:!1,grow:!0},{xtype:'panel',itemId:'evidence-requirements-container',title:'Evidence Requirements',tbar:[{xtype:'numberfield',fieldLabel:'Level',minValue:1,isFormField:!1,listeners:{change:function(){this.next('button').setDisabled(!this.getValue())}}},{xtype:'tbfill'},{text:'Add Level',action:'add',disabled:!0,glyph:61525,cls:'glyph-success',handler:function(){var c=this.up('form'),a=this.prev('numberfield'),b=a.getValue();if(Ext.isNumeric(b)){c.fireEvent('addevidencerequirementlevel',c,a,b)}}}]}],buttons:[{itemId:'revertBtn',disabled:!0,text:'Revert Changes',cls:'glyph-danger',glyph:61527},{xtype:'tbfill'},{itemId:'saveBtn',disabled:!0,text:'Save Changes',cls:'glyph-success',glyph:61528}],loadRecord:function(d){var f=this,c=f.down('#evidence-requirements-container'),a=0,e=[],b;c.removeAll();if(d&&(a=d.get('DemonstrationsRequired'))){for(b in a){if(a.hasOwnProperty(b)){e.push(Ext.factory({level:b,value:a[b]},'Slate.cbl.admin.view.skills.EvidenceRequirementsField'))}}}c.add(e);f.callParent(arguments)},getEvidenceRequirements:function(d){var e=this,c={},b=e.query('cbl-admin-skills-evidencerequirementsfield'),a=0;for(;a<b.length;a++){c[b[a].getLevel()]=b[a].getValue()}if(d){return c[d]}return c}});Ext.define('Slate.cbl.admin.view.skills.Manager',{extend:'Ext.Container',xtype:'cbl-admin-skills-manager',requires:['Slate.cbl.admin.view.skills.Grid','Slate.cbl.admin.view.skills.Form'],layout:'border',items:[{region:'west',split:!0,xtype:'cbl-admin-skills-grid',autoScroll:!0,width:500},{region:'center',xtype:'cbl-admin-skills-form',flex:1}]});Ext.define('Slate.cbl.admin.controller.Skills',{extend:'Ext.app.Controller',views:['skills.Manager@Slate.cbl.admin.view'],stores:['Skills@Slate.cbl.admin.store'],refs:{skillsManager:{selector:'cbl-admin-skills-manager',autoCreate:!0,xtype:'cbl-admin-skills-manager'},skillsGrid:{selector:'cbl-admin-skills-grid',autoCreate:!0,xtype:'cbl-admin-skills-grid'},skillsForm:{selector:'cbl-admin-skills-form',autoCreate:!0,xtype:'cbl-admin-skills-form'},evidenceRequirementCt:'#evidence-requirements-container',saveBtn:'cbl-admin-skills-form #saveBtn',revertBtn:'cbl-admin-skills-form #revertBtn',addLevelBtn:'cbl-admin-skills-form button[action=add]',settingsNavPanel:'settings-navpanel'},control:{skillsGrid:{select:'onSkillSelect'},skillsForm:{addevidencerequirementlevel:'addEvidenceRequirementLevel',dirtychange:'onFormDirtyChange'},saveBtn:{click:'onSaveSkillClick'},revertBtn:{click:'onRevertChangesClick'},'cbl-admin-skills-evidencerequirementsfield':{destroy:'onEvidenceRequirementsFieldDestroyed'}},routes:{'settings/cbl/skills':'showSkills'},showSkills:function(){var a=this,c=a.getSkillsManager(),d=a.getSkillsGrid(),b=a.getSettingsNavPanel();Ext.suspendLayouts();Ext.util.History.suspendState();b.setActiveLink('settings/cbl/skills');b.expand();Ext.util.History.resumeState(!1);a.getApplication().getController('Viewport').loadCard(c);d.getStore().load();Ext.resumeLayouts(!0)},onSkillSelect:function(){var c=this,b=c.getSkillsForm(),d=c.getSkillsGrid(),a=d.getSelectionModel().getSelection()[0];b.enable();b.loadRecord(a);b.setTitle(a.get('Code'));if(a.isPhantom){a.set('DemonstrationsRequired',[])}c.syncFormButtons()},onSaveSkillClick:function(){var c=this,a=c.getSkillsForm(),b=a.getRecord();a.updateRecord(b);b.set('DemonstrationsRequired',a.getEvidenceRequirements());if(b.dirty){a.setLoading('Saving skill&hellip;');b.save({callback:function(d,b,c){a.setLoading(!1);if(c){a.loadRecord(d)}else {Ext.Msg.alert('Failed to save skill','This skill failed to save to the server:<br><br>'+(b.getError()||'Unknown reason, try again or contact support'))}}})}},onFormDirtyChange:function(b,a){this.syncFormButtons()},syncFormButtons:function(){var a=this,b=a.getSkillsForm(),e=b.isDirty(),f=a.getRevertBtn(),g=a.getSaveBtn(),d=a.getAddLevelBtn(),c=JSON.stringify(b.getRecord().get('DemonstrationsRequired'))!==JSON.stringify(b.getEvidenceRequirements());d.setDisabled(!Ext.isNumeric(d.prev('numberfield').getValue()));f.setDisabled(!e&&!c);g.setDisabled(!e&&!c)},onRevertChangesClick:function(b){var a=this.getSkillsForm();a.reset();a.loadRecord(a.getRecord());this.syncFormButtons()},onEvidenceRequirementsFieldDestroyed:function(){this.syncFormButtons()},addEvidenceRequirementLevel:function(f,e,a){var g=this,d=g.getEvidenceRequirementCt(),b=f.getEvidenceRequirements(),c=0;if(b[a]!==undefined){return Ext.Msg.alert('Error','This level already exists. Please select another level.')}b[a]=!0;c=Object.keys(b).sort(function(b,c){if(Ext.isNumeric(b)&&Ext.isNumeric(c)){return parseInt(b,10)-parseInt(c,10)}else {if(Ext.isNumeric(b)){return -1}else {if(Ext.isNumeric(c)){return 1}else {return 0}}}}).indexOf(a.toString());d.insert(c,{xtype:'cbl-admin-skills-evidencerequirementsfield',level:a});e.reset();this.syncFormButtons()}});Ext.define('Slate.cbl.admin.overrides.SlateAdmin',{override:'SlateAdmin.Application',requires:['Slate.cbl.admin.controller.Skills'],initControllers:function(){this.callParent();this.getController('Slate.cbl.admin.controller.Skills')}});